<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ×¤×¨×•×™×§×˜×™×</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- PDF.js for PDF support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Cropper.js for image cropping -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    
    <!-- pdf-lib for PDF generation -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="text-2xl mb-4">â³ ×˜×•×¢×Ÿ...</div>
            </div>
        </div>
    </div>
    
    <!-- Version Info Footer -->
    <div class="fixed bottom-2 left-2 text-xs text-gray-400 bg-white/50 backdrop-blur-sm px-2 py-1 rounded">
        v0.1.9 | expenses
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBimaxCYm5k-vQ44nWROiTg3ffgkYuY3kU",
            authDomain: "elka-73bb6.firebaseapp.com",
            projectId: "elka-73bb6",
            storageBucket: "elka-73bb6.firebasestorage.app",
            messagingSenderId: "922263387717",
            appId: "1:922263387717:web:f64a6703fd27b82db5ad2c",
            measurementId: "G-K075PYBHVG"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        // Development mode - set to false for production
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        // Comment out emulator usage for now - just use production for testing
        // To enable emulators later (requires Java), uncomment below:
        /*
        if (isDevelopment) {
            console.log('ğŸ”§ Running in DEVELOPMENT mode with Firebase Emulators');
            db.useEmulator('localhost', 8080);
            auth.useEmulator('http://localhost:9099');
            storage.useEmulator('localhost', 9199);
        }
        */
        
        if (isDevelopment) {
            console.log('ğŸ”§ Running in DEVELOPMENT mode (connected to production Firestore)');
        } else {
            console.log('ğŸš€ Running in PRODUCTION mode');
        }
        
        // Authentication restrictions
        const ALLOWED_DOMAIN = 'elka-hashmal.co.il';
        const EMAIL_WHITELIST = [
            'admin@elka-hashmal.co.il',
            // Add more whitelisted emails here
        ];
        
        // Session management
        const SESSION_DURATION_DAYS = 7; // 1 week
        const INACTIVITY_TIMEOUT_HOURS = 24; // 24 hours
        let inactivityTimeout;
        let lastActivityTime;
        
        console.log('Firebase initialized');
        console.log('Development mode:', isDevelopment);

        // Categories
        const categories = [
            '×‘×˜×•×Ÿ ×•××•×¦×¨×™×•',
            '×›×‘×œ×™×',
            '×›×œ×™× ×›×‘×“×™×',
            '× ×•×ª× ×™ ×©×™×¨×•×ª',
            '×¢××•×“×™×',
            '×¤× ×¡×™×',
            '×¦×™× ×•×¨×•×ª',
            '×§×‘×œ× ×™ ××©× ×”',
            '×©×•× ×•×ª'
        ];

        // State
        let state = {
            clients: [],
            projects: [],
            allProjects: [], // All projects across all clients with full data
            suppliers: [],
            orders: [],
            selectedClient: null,
            selectedProject: null,
            selectedSupplier: null,
            showNewClient: false,
            showNewProject: false,
            showNewInvoice: false,
            showNewSupplier: false,
            showNewOrder: false,
            editingClient: null,
            editingProject: null,
            editingInvoice: null,
            editingSupplier: null,
            editingOrder: null,
            viewingAttachment: null,
            view: 'clients', // 'clients', 'projects', 'suppliers', 'orders', 'all-projects'
            projectStatusFilter: 'all', // 'all' or specific status
            allProjectsStatusFilter: 'all', // Status filter for all-projects view
            ordersViewTab: 'all', // 'all' or 'by-project'
            user: null, // Firebase auth user
            loading: true, // Loading state
            newClient: { name: '', email: '', phone: '', notes: '' },
            newProject: { name: '', revenue: '', status: '×¤×ª×•×—', creationDate: new Date().toISOString().split('T')[0], description: '', activeInSchedule: true },
            newInvoice: {
                supplier: '',
                invoiceNumber: '',
                date: new Date().toISOString().split('T')[0],
                items: [{ description: '', amount: '', category: '×©×•× ×•×ª' }],
                attachments: []
            },
            newSupplier: {
                name: '',
                contactName: '',
                contactPhone: '',
                contactEmail: '',
                paymentConditions: '',
                documents: []
            },
            newOrder: {
                selectedClientId: '',
                projectId: '',
                supplierId: '',
                items: [{ description: '', unit: '×™×—\'', quantity: '', price: '', sum: 0 }],
                orderDate: new Date().toISOString().split('T')[0],
                comments: '',
                deliveryAddress: '',
                orderedBy: ''
            },
            ocrProcessing: false,
            ocrProgress: 0,
            ocrResults: null,
            ocrMethod: 'tesseract',
            cropperInstance: null,
            showCropModal: false,
            pendingOCRFile: null,
            pdfTemplate: null, // URL to uploaded PDF template
            loadingSuppliers: false,
            loadingOrders: false,
            suppliersLoaded: false,
            ordersLoaded: false,
            // Work Schedule state
            workAssignments: [], // Array of {id, workerId, projectId, projectName, date, clientId, clientName}
            calendarViewMode: 'week', // 'week' or 'month'
            calendarDate: new Date(), // Current date being viewed
            draggedWorker: null, // Currently dragged worker
            loadingAssignments: false,
            assignmentsLoaded: false,
            // Worker daily rates (expenses calculated from work assignments)
            workerDailyRates: {
                'a': 500, // ×™××¡×¨
                'b': 500, // ×¤×¨×™×“
                'c': 500, // ×—××•×“×™
                'd': 500, // ×¡×œ×™×××Ÿ
                'e': 500  // ××™×©×œ
            },
            editingWorkerRates: false
        };

        // Project statuses
        const projectStatuses = ['×¤×ª×•×—', '××•××“×Ÿ', '×”×–×× ×”', '×‘×‘×™×¦×•×¢', '×—×©×‘×•×Ÿ', '×œ×ª×©×œ×•×', '×©×•×œ×'];
        
        // Workers (hardcoded for now)
        const workers = [
            { id: 'a', name: '×™××¡×¨' },
            { id: 'b', name: '×¤×¨×™×“' },
            { id: 'c', name: '×—××•×“×™' },
            { id: 'd', name: '×¡×œ×™×××Ÿ'},
            { id: 'e', name: '××™×©×œ'}
        ];

        // ===== AUTHENTICATION FUNCTIONS =====
        
        function isSessionValid(user) {
            if (!user || !user.metadata) return false;
            
            // Check if session is older than 7 days
            const authTime = user.metadata.lastSignInTime;
            if (authTime) {
                const lastSignIn = new Date(authTime);
                const now = new Date();
                const daysSinceSignIn = (now - lastSignIn) / (1000 * 60 * 60 * 24);
                
                if (daysSinceSignIn > SESSION_DURATION_DAYS) {
                    console.log('Session expired: more than 7 days since last sign in');
                    return false;
                }
            }
            
            return true;
        }
        
        function resetInactivityTimeout() {
            lastActivityTime = Date.now();
            clearTimeout(inactivityTimeout);
            
            // Set timeout for 24 hours of inactivity
            inactivityTimeout = setTimeout(() => {
                console.log('Session expired: 24 hours of inactivity');
                signOut();
            }, INACTIVITY_TIMEOUT_HOURS * 60 * 60 * 1000);
        }
        
        function setupActivityTracking() {
            // Track user activity
            const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
            
            activityEvents.forEach(event => {
                document.addEventListener(event, resetInactivityTimeout, true);
            });
            
            // Initialize the timeout
            resetInactivityTimeout();
        }
        
        function isEmailAllowed(email) {
            if (!email) return false;
            
            // Check if email is in whitelist
            if (EMAIL_WHITELIST.includes(email.toLowerCase())) {
                return true;
            }
            
            // Check if email is from allowed domain using improved domain extraction
            const atIndex = email.lastIndexOf('@');
            if (atIndex === -1) return false;
            
            const emailDomain = email.substring(atIndex + 1);
            return emailDomain.toLowerCase() === ALLOWED_DOMAIN.toLowerCase();
        }
        
        function showAccessDeniedMessage(email) {
            const message = `
                <div id="access-denied-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-8 max-w-md mx-4">
                        <div class="text-center">
                            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">×’×™×©×” × ×“×—×ª×”</h3>
                            <p class="text-sm text-gray-500 mb-4">
                                ×”×—×©×‘×•×Ÿ ${email} ××™× ×• ××•×¨×©×” ×œ×’×©×ª ×œ××¢×¨×›×ª.
                            </p>
                            <p class="text-sm text-gray-500 mb-6">
                                ×¨×§ ××©×ª××©×™× ×-${ALLOWED_DOMAIN} ××• ×¨×©×™××ª ××©×ª××©×™× ××•×¨×©×™×ª ×™×›×•×œ×™× ×œ×’×©×ª ×œ××¢×¨×›×ª.
                            </p>
                            <button onclick="closeAccessDeniedModal()" class="w-full bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 cursor-pointer">
                                ×™×¦×™××”
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', message);
        }
        
        function closeAccessDeniedModal() {
            console.log('closeAccessDeniedModal called');
            const modal = document.getElementById('access-denied-modal');
            if (modal) {
                console.log('Modal found, removing...');
                modal.remove();
                console.log('Modal removed');
            } else {
                console.log('Modal not found');
            }
            // Also sign out the user
            signOut();
        }
        
        async function signInWithGoogle() {
            try {
                if (isDevelopment) {
                    // Development mode - create a mock user
                    const mockUser = {
                        uid: 'dev-user-' + Date.now(),
                        email: 'dev@example.com',
                        displayName: 'Developer User',
                        photoURL: null
                    };
                    console.log('Development mode - using mock user:', mockUser);
                    
                    // Manually set the user state and trigger the auth state change
                    state.user = mockUser;
                    state.loading = false;
                    onAuthStateChanged(mockUser);
                    
                    return mockUser;
                } else {
                    // Production mode - use real Google Auth
                    try {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        provider.addScope('email');
                        provider.addScope('profile');
                        
                        const result = await auth.signInWithPopup(provider);
                        console.log('User signed in:', result.user);
                        
                        // Check if user email is allowed
                        const userEmail = result.user.email;
                        if (!isEmailAllowed(userEmail)) {
                            console.log('Access denied for email:', userEmail);
                            await auth.signOut(); // Sign out the user
                            showAccessDeniedMessage(userEmail);
                            return null;
                        }
                        
                        return result.user;
                    } catch (authError) {
                        if (authError.code === 'auth/configuration-not-found') {
                            alert('Google Authentication ×œ× ××•×’×“×¨ ×‘×¤×¨×•×™×§×˜ Firebase. ×× × ×”×¤×¢×œ ××ª Google Auth ×‘×§×•× ×¡×•×œ Firebase.');
                            throw authError;
                        } else {
                            throw authError;
                        }
                    }
                }
            } catch (error) {
                console.error('Error signing in:', error);
                alert('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: ' + error.message);
                throw error;
            }
        }
        
        async function signOut() {
            try {
                // Remove any access denied modal
                const modal = document.getElementById('access-denied-modal');
                if (modal) {
                    modal.remove();
                }
                
                if (isDevelopment) {
                    // Development mode - just clear the user
                    state.user = null;
                    state.loading = false;
                    console.log('Development mode - user signed out');
                } else {
                    // Production mode - use real Firebase signOut
                    await auth.signOut();
                    console.log('User signed out');
                }
            } catch (error) {
                console.error('Error signing out:', error);
                alert('×©×’×™××” ×‘×”×ª× ×ª×§×•×ª: ' + error.message);
            }
        }
        
        function onAuthStateChanged(user) {
            state.user = user;
            state.loading = false;
            
            if (user) {
                console.log('User authenticated:', user.email);
                
                // In production, validate user access
                if (!isDevelopment && !isEmailAllowed(user.email)) {
                    console.log('Access denied for existing user:', user.email);
                    showAccessDeniedMessage(user.email);
                    auth.signOut(); // Sign out the user
                    return;
                }
                
                // Check session validity (only in production)
                if (!isDevelopment && !isSessionValid(user)) {
                    console.log('Session expired, signing out user');
                    alert('×”×¤×’×™×©×” ×¤×’×”. ×× × ×”×ª×—×‘×¨ ××—×“×©.');
                    auth.signOut();
                    return;
                }
                
                // Setup activity tracking for authenticated users
                setupActivityTracking();

                // Load data when user is authenticated and authorized
                loadClients();
                loadAllProjects(); // Load all projects at startup
                // Initialize suppliers and orders arrays if not already set
                if (!state.suppliers) {
                    state.suppliers = [];
                }
                if (!state.orders) {
                    state.orders = [];
                }
            } else {
                console.log('User not authenticated');
                // Clear activity tracking
                clearTimeout(inactivityTimeout);
                // Clear data when user is not authenticated
                state.clients = [];
                state.projects = [];
                state.suppliers = [];
                state.orders = [];
                state.selectedClient = null;
                state.selectedProject = null;
            }
            
            render();
        }
        
        // Listen for authentication state changes
        if (!isDevelopment) {
            // Production mode - use real Firebase Auth
            auth.onAuthStateChanged(onAuthStateChanged);
        } else {
            // Development mode - simulate authentication state
            console.log('Development mode: initializing...');
            state.loading = false;
            // Don't call onAuthStateChanged yet - user needs to click login
            render();
        }

        // ===== CLIENT FUNCTIONS =====
        
        async function loadClients() {
            if (!state.user) {
                console.log('Cannot load clients: user not authenticated');
                return;
            }
            try {
                console.log('Loading clients...');
                const snapshot = await db.collection('clients').get();
                state.clients = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                state.clients.sort((a, b) => {
                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : (a.createdAt || new Date(0));
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : (b.createdAt || new Date(0));
                    return bTime - aTime;
                });
                console.log('Loaded clients:', state.clients.length);
                console.log('Clients data:', state.clients);
                render();
            } catch (error) {
                console.error('Error loading clients:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    stack: error.stack,
                    user: state.user,
                    isDevelopment: isDevelopment
                });
                
                // Only show error if user is authenticated (not during initial load)
                if (state.user) {
                    let errorMsg = '×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×§×•×—×•×ª';
                    if (error.code === 'permission-denied') {
                        errorMsg += ': ××™×Ÿ ×”×¨×©××•×ª ×œ×’×™×©×”. ×× × ×•×“× ×©××ª×” ××—×•×‘×¨ ×¢× ×—×©×‘×•×Ÿ ××•×¨×©×”.';
                    } else if (error.code === 'unavailable') {
                        errorMsg += ': ×©×™×¨×•×ª Firestore ×œ× ×–××™×Ÿ. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.';
                    } else {
                        errorMsg += ': ' + (error.message || error.code || '×©×’×™××” ×œ× ×™×“×•×¢×”');
                    }
                    alert(errorMsg);
                }
            }
        }

        async function addClient() {
            if (!state.newClient.name) {
                alert('×™×© ×œ×”×–×™×Ÿ ×©× ×œ×§×•×—');
                return;
            }
            
            try {
                const clientData = {
                    name: state.newClient.name,
                    email: state.newClient.email,
                    phone: state.newClient.phone,
                    notes: state.newClient.notes,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection('clients').add(clientData);
                console.log('Client added:', docRef.id);
                
                state.clients.unshift({
                    id: docRef.id,
                    ...clientData,
                    createdAt: new Date()
                });
                
                state.newClient = { name: '', email: '', phone: '', notes: '' };
                state.showNewClient = false;
                render();
            } catch (error) {
                console.error('Error adding client:', error);
                alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×œ×§×•×—: ' + error.message);
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×œ×§×•×—? ×›×œ ×”×¤×¨×•×™×§×˜×™× ×•×”×—×©×‘×•× ×™×•×ª ×©×œ×• ×™×™××—×§×•!')) return;
            
            try {
                // Delete all projects for this client
                const projectsSnapshot = await db.collection('projects')
                    .where('clientId', '==', clientId).get();
                
                const batch = db.batch();
                
                // Delete all invoices for each project
                for (const projectDoc of projectsSnapshot.docs) {
                    const invoicesSnapshot = await db.collection('invoices')
                        .where('projectId', '==', projectDoc.id).get();
                    invoicesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    batch.delete(projectDoc.ref);
                }
                
                // Delete client
                batch.delete(db.collection('clients').doc(clientId));
                await batch.commit();
                
                state.clients = state.clients.filter(c => c.id !== clientId);
                if (state.selectedClient?.id === clientId) {
                    state.selectedClient = null;
                    state.projects = [];
                }
                render();
            } catch (error) {
                console.error('Error deleting client:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×œ×§×•×—: ' + error.message);
            }
        }

        async function saveEditClient() {
            if (!state.editingClient.name) return;
            
            try {
                const updates = {
                    name: state.editingClient.name,
                    email: state.editingClient.email,
                    phone: state.editingClient.phone,
                    notes: state.editingClient.notes
                };
                
                await db.collection('clients').doc(state.editingClient.id).update(updates);
                
                state.clients = state.clients.map(c =>
                    c.id === state.editingClient.id ? { ...c, ...updates } : c
                );
                
                if (state.selectedClient?.id === state.editingClient.id) {
                    state.selectedClient = { ...state.selectedClient, ...updates };
                }
                
                state.editingClient = null;
                render();
            } catch (error) {
                console.error('Error updating client:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×œ×§×•×—: ' + error.message);
            }
        }

        async function selectClient(clientId) {
            const client = state.clients.find(c => c.id === clientId);
            if (!client) return;
            
            state.selectedClient = client;
            state.view = 'projects';
            updateHistory();
            await loadProjectsForClient(clientId);
        }

        // ===== SUPPLIER FUNCTIONS =====
        
        async function loadSuppliers() {
            if (!state.user) {
                console.log('Cannot load suppliers: user not authenticated');
                return;
            }
            if (state.loadingSuppliers) {
                console.log('Already loading suppliers, skipping...');
                return;
            }
            try {
                state.loadingSuppliers = true;
                console.log('Loading suppliers...');
                const snapshot = await db.collection('suppliers').get();
                state.suppliers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                state.suppliers.sort((a, b) => {
                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : (a.createdAt || new Date(0));
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : (b.createdAt || new Date(0));
                    return bTime - aTime;
                });
                console.log('Loaded suppliers:', state.suppliers.length);
                state.suppliersLoaded = true;
                state.loadingSuppliers = false;
                render();
            } catch (error) {
                console.error('Error loading suppliers:', error);
                state.loadingSuppliers = false;
                if (state.user) {
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×¤×§×™×: ' + error.message);
                }
            }
        }

        async function addSupplier() {
            if (!state.newSupplier.name) {
                alert('×™×© ×œ×”×–×™×Ÿ ×©× ×¡×¤×§');
                return;
            }
            
            try {
                console.log('Adding supplier:', state.newSupplier.name);
                
                const supplierData = {
                    name: state.newSupplier.name,
                    contactName: state.newSupplier.contactName || '',
                    contactPhone: state.newSupplier.contactPhone || '',
                    contactEmail: state.newSupplier.contactEmail || '',
                    paymentConditions: state.newSupplier.paymentConditions || '',
                    documents: state.newSupplier.documents || [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: state.user.uid
                };
                
                const docRef = await db.collection('suppliers').add(supplierData);
                console.log('âœ… Supplier added successfully:', docRef.id);
                
                // Initialize suppliers array if not exists
                if (!state.suppliers) {
                    state.suppliers = [];
                }
                
                state.suppliers.unshift({
                    id: docRef.id,
                    ...supplierData,
                    createdAt: new Date()
                });
                
                state.newSupplier = {
                    name: '',
                    contactName: '',
                    contactPhone: '',
                    contactEmail: '',
                    paymentConditions: '',
                    documents: []
                };
                state.showNewSupplier = false;
                render();
                
                alert('×¡×¤×§ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('âŒ Error adding supplier:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                let errorMsg = '×©×’×™××” ×‘×”×•×¡×¤×ª ×¡×¤×§';
                if (error.code === 'permission-denied') {
                    errorMsg += ': ××™×Ÿ ×”×¨×©××•×ª ×œ×›×ª×™×‘×”';
                } else {
                    errorMsg += ': ' + error.message;
                }
                alert(errorMsg);
            }
        }

        async function updateSupplier(supplierId) {
            if (!state.editingSupplier.name) {
                alert('×™×© ×œ×”×–×™×Ÿ ×©× ×¡×¤×§');
                return;
            }
            
            try {
                const updates = {
                    name: state.editingSupplier.name,
                    contactName: state.editingSupplier.contactName,
                    contactPhone: state.editingSupplier.contactPhone,
                    contactEmail: state.editingSupplier.contactEmail,
                    paymentConditions: state.editingSupplier.paymentConditions,
                    documents: state.editingSupplier.documents
                };
                
                await db.collection('suppliers').doc(supplierId).update(updates);
                
                state.suppliers = state.suppliers.map(s =>
                    s.id === supplierId ? { ...s, ...updates } : s
                );
                
                state.editingSupplier = null;
                render();
            } catch (error) {
                console.error('Error updating supplier:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×¤×§: ' + error.message);
            }
        }

        async function deleteSupplier(supplierId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×¡×¤×§?')) return;
            
            try {
                // Check if supplier has orders
                const ordersSnapshot = await db.collection('orders')
                    .where('supplierId', '==', supplierId)
                    .limit(1)
                    .get();
                
                if (!ordersSnapshot.empty) {
                    alert('×œ×× ×™×ª×Ÿ ×œ××—×•×§ ×¡×¤×§ ×©×™×© ×œ×• ×”×–×× ×•×ª');
                    return;
                }
                
                await db.collection('suppliers').doc(supplierId).delete();
                
                state.suppliers = state.suppliers.filter(s => s.id !== supplierId);
                render();
            } catch (error) {
                console.error('Error deleting supplier:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×¡×¤×§: ' + error.message);
            }
        }

        async function uploadSupplierDocument(supplierId, file) {
            try {
                const storageRef = storage.ref(`supplier-documents/${supplierId}/${file.name}`);
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                
                // Update supplier documents array
                const supplier = state.suppliers.find(s => s.id === supplierId);
                const documents = supplier.documents || [];
                documents.push({ name: file.name, url: url, uploadedAt: new Date() });
                
                await db.collection('suppliers').doc(supplierId).update({ documents });
                
                supplier.documents = documents;
                render();
                
                return url;
            } catch (error) {
                console.error('Error uploading document:', error);
                alert('×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥: ' + error.message);
                throw error;
            }
        }

        async function removeSupplierDocument(supplierId, docIndex) {
            try {
                const supplier = state.suppliers.find(s => s.id === supplierId);
                const documents = [...supplier.documents];
                documents.splice(docIndex, 1);
                
                await db.collection('suppliers').doc(supplierId).update({ documents });
                
                supplier.documents = documents;
                render();
            } catch (error) {
                console.error('Error removing document:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×§×•×‘×¥: ' + error.message);
            }
        }

        // ===== PROJECT FUNCTIONS =====
        
        async function loadProjectsForClient(clientId) {
            try {
                console.log('Loading projects for client:', clientId);
                const snapshot = await db.collection('projects')
                    .where('clientId', '==', clientId)
                    .get();
                
                state.projects = await Promise.all(snapshot.docs.map(async doc => {
                    const projectData = {
                        id: doc.id,
                        ...doc.data()
                    };
                    
                    // Load invoices for calculations
                    const invoices = await loadInvoices(doc.id);
                    projectData.invoices = invoices;
                    
                    return projectData;
                }));
                
                state.projects.sort((a, b) => {
                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : (a.createdAt || new Date(0));
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : (b.createdAt || new Date(0));
                    return bTime - aTime;
                });
                
                console.log('Loaded projects:', state.projects.length);
                render();
            } catch (error) {
                console.error('Error loading projects:', error);
                // Only show error if user is authenticated (not during initial load)
                if (state.user) {
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×•×™×§×˜×™×: ' + error.message);
                }
            }
        }

        async function addProject() {
            if (!state.newProject.name || !state.selectedClient) {
                alert('×™×© ×œ×”×–×™×Ÿ ×©× ×œ×¤×¨×•×™×§×˜');
                return;
            }
            
            try {
                const projectData = {
                    clientId: state.selectedClient.id,
                    name: state.newProject.name,
                    revenue: parseFloat(state.newProject.revenue) || 0,
                    status: state.newProject.status || '×¤×ª×•×—',
                    description: state.newProject.description || '',
                    activeInSchedule: state.newProject.activeInSchedule !== false,
                    createdAt: new Date(state.newProject.creationDate)
                };
                
                const docRef = await db.collection('projects').add(projectData);
                console.log('Project added:', docRef.id);
                
                state.projects.unshift({
                    id: docRef.id,
                    ...projectData,
                    createdAt: new Date(state.newProject.creationDate),
                    invoices: []
                });
                
                state.newProject = { name: '', revenue: '', status: '×¤×ª×•×—', creationDate: new Date().toISOString().split('T')[0], description: '', activeInSchedule: true };
                state.showNewProject = false;
                render();
            } catch (error) {
                console.error('Error adding project:', error);
                alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×¤×¨×•×™×§×˜: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×¤×¨×•×™×§×˜?')) return;
            
            try {
                const batch = db.batch();
                
                // Delete all invoices
                const invoicesSnapshot = await db.collection('invoices')
                    .where('projectId', '==', projectId).get();
                invoicesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                
                // Delete project
                batch.delete(db.collection('projects').doc(projectId));
                await batch.commit();
                
                state.projects = state.projects.filter(p => p.id !== projectId);
                if (state.selectedProject?.id === projectId) {
                    state.selectedProject = null;
                }
                render();
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×¤×¨×•×™×§×˜: ' + error.message);
            }
        }

        async function saveEditProject() {
            if (!state.editingProject.name) return;
            
            try {
                const updates = {
                    name: state.editingProject.name,
                    revenue: parseFloat(state.editingProject.revenue) || 0,
                    status: state.editingProject.status || '×¤×ª×•×—',
                    description: state.editingProject.description || '',
                    activeInSchedule: state.editingProject.activeInSchedule !== false
                };
                
                // Only update creationDate if it's provided and valid
                if (state.editingProject.creationDate) {
                    updates.creationDate = new Date(state.editingProject.creationDate);
                }
                
                await db.collection('projects').doc(state.editingProject.id).update(updates);
                
                state.projects = state.projects.map(p =>
                    p.id === state.editingProject.id ? { ...p, ...updates } : p
                );
                
                if (state.selectedProject?.id === state.editingProject.id) {
                    state.selectedProject = { ...state.selectedProject, ...updates };
                }
                
                state.editingProject = null;
                render();
            } catch (error) {
                console.error('Error updating project:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¤×¨×•×™×§×˜: ' + error.message);
            }
        }

        async function selectProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            state.selectedProject = { ...project };
            const invoices = await loadInvoices(projectId);
            state.selectedProject.invoices = invoices;
            updateHistory();
            render();
        }

        // ===== ORDER FUNCTIONS =====

        async function loadAllProjects() {
            if (!state.user) {
                console.log('Cannot load all projects: user not authenticated');
                return;
            }

            // Check if already loaded (cache)
            if (state.allProjects && state.allProjects.length > 0) {
                console.log('Using cached projects list');
                return;
            }

            try {
                console.log('Loading all projects with full data...');
                const snapshot = await db.collection('projects').get();

                state.allProjects = await Promise.all(snapshot.docs.map(async doc => {
                    const data = doc.data();
                    const client = state.clients.find(c => c.id === data.clientId);

                    // Load invoices for this project to calculate totals
                    const invoices = await loadInvoices(doc.id);

                    return {
                        id: doc.id,
                        ...data,
                        clientName: client ? client.name : '×œ×§×•×— ×œ× ×™×“×•×¢',
                        invoices: invoices
                    };
                }));

                // Sort by creation date (newest first)
                state.allProjects.sort((a, b) => {
                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : (a.createdAt || new Date(0));
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : (b.createdAt || new Date(0));
                    return bTime - aTime;
                });

                console.log('Loaded all projects:', state.allProjects.length);
                render();
            } catch (error) {
                console.error('Error loading all projects:', error);
                if (state.user) {
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×›×œ ×”×¤×¨×•×™×§×˜×™×: ' + error.message);
                }
            }
        }

        async function loadOrders() {
            if (!state.user) {
                console.log('Cannot load orders: user not authenticated');
                return;
            }
            if (state.loadingOrders) {
                console.log('Already loading orders, skipping...');
                return;
            }
            try {
                state.loadingOrders = true;
                console.log('Loading orders...');
                const snapshot = await db.collection('orders').get();
                state.orders = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                state.orders.sort((a, b) => {
                    const aTime = a.createdAt?.toDate ? a.createdAt.toDate() : (a.createdAt || new Date(0));
                    const bTime = b.createdAt?.toDate ? b.createdAt.toDate() : (b.createdAt || new Date(0));
                    return bTime - aTime;
                });
                console.log('Loaded orders:', state.orders.length);
                state.ordersLoaded = true;
                state.loadingOrders = false;
                render();
            } catch (error) {
                console.error('Error loading orders:', error);
                state.loadingOrders = false;
                if (state.user) {
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×–×× ×•×ª: ' + error.message);
                }
            }
        }

        async function generateOrderNumber() {
            const currentYear = new Date().getFullYear();
            const yearShort = String(currentYear).slice(-2); // e.g., "25" for 2025
            
            try {
                const counterRef = db.collection('orderCounter').doc(yearShort);
                
                // Use Firestore transaction for atomic increment
                const orderNumber = await db.runTransaction(async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    
                    let counter = 1;
                    if (counterDoc.exists) {
                        counter = counterDoc.data().counter + 1;
                        transaction.update(counterRef, { counter: counter });
                    } else {
                        transaction.set(counterRef, { year: yearShort, counter: counter });
                    }
                    
                    // Format: YY/XXX (e.g., 25/001)
                    return `${yearShort}/${String(counter).padStart(3, '0')}`;
                });
                
                return orderNumber;
            } catch (error) {
                console.error('Error generating order number:', error);
                throw error;
            }
        }

        async function addOrder() {
            if (!state.newOrder.projectId) {
                alert('×™×© ×œ×‘×—×•×¨ ×¤×¨×•×™×§×˜');
                return;
            }
            
            if (!state.newOrder.supplierId) {
                alert('×™×© ×œ×‘×—×•×¨ ×¡×¤×§');
                return;
            }
            
            const validItems = state.newOrder.items.filter(item => 
                item.description && item.quantity && item.price && 
                parseFloat(item.quantity) > 0 && parseFloat(item.price) > 0
            );
            
            if (validItems.length === 0) {
                alert('×™×© ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“ ×¢× ×›××•×ª ×•××—×™×¨');
                return;
            }
            
            try {
                // Calculate sums
                const itemsWithSum = validItems.map(item => ({
                    ...item,
                    quantity: parseFloat(item.quantity),
                    price: parseFloat(item.price),
                    sum: parseFloat(item.quantity) * parseFloat(item.price)
                }));
                
                const totalSum = itemsWithSum.reduce((acc, item) => acc + item.sum, 0);
                
                // Generate order number
                const orderNumber = await generateOrderNumber();
                
                // Get project and supplier names
                const project = state.allProjects.find(p => p.id === state.newOrder.projectId);
                const supplier = state.suppliers.find(s => s.id === state.newOrder.supplierId);
                
                if (!project || !supplier) {
                    console.error('Project or supplier not found:', { 
                        projectId: state.newOrder.projectId, 
                        supplierId: state.newOrder.supplierId,
                        allProjects: state.allProjects,
                        suppliers: state.suppliers
                    });
                    alert('×¤×¨×•×™×§×˜ ××• ×¡×¤×§ ×œ× × ××¦××•');
                    return;
                }
                
                const orderData = {
                    orderNumber: orderNumber,
                    projectId: state.newOrder.projectId,
                    projectName: project.name,
                    supplierId: state.newOrder.supplierId,
                    supplierName: supplier.name,
                    items: itemsWithSum,
                    totalSum: totalSum,
                    orderDate: state.newOrder.orderDate,
                    comments: state.newOrder.comments,
                    deliveryAddress: state.newOrder.deliveryAddress,
                    orderedBy: state.newOrder.orderedBy,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: state.user.uid
                };
                
                const docRef = await db.collection('orders').add(orderData);
                console.log('Order added:', docRef.id);
                
                state.orders.unshift({
                    id: docRef.id,
                    ...orderData,
                    createdAt: new Date()
                });
                
                state.newOrder = {
                    selectedClientId: '',
                    projectId: '',
                    supplierId: '',
                    items: [{ description: '', unit: '×™×—\'', quantity: '', price: '', sum: 0 }],
                    orderDate: new Date().toISOString().split('T')[0],
                    comments: '',
                    deliveryAddress: '',
                    orderedBy: ''
                };
                state.showNewOrder = false;
                render();
            } catch (error) {
                console.error('Error adding order:', error);
                alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×–×× ×”: ' + error.message);
            }
        }

        async function updateOrder(orderId) {
            if (!state.editingOrder.projectId || !state.editingOrder.supplierId) {
                alert('×™×© ×œ×‘×—×•×¨ ×¤×¨×•×™×§×˜ ×•×¡×¤×§');
                return;
            }
            
            const validItems = state.editingOrder.items.filter(item => 
                item.description && item.price && parseFloat(item.price) > 0
            );
            
            if (validItems.length === 0) {
                alert('×™×© ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“');
                return;
            }
            
            try {
                const itemsWithSum = validItems.map(item => ({
                    ...item,
                    price: parseFloat(item.price),
                    sum: parseFloat(item.price)
                }));
                
                const totalSum = itemsWithSum.reduce((acc, item) => acc + item.sum, 0);
                
                const project = state.clients.flatMap(c => state.projects).find(p => p.id === state.editingOrder.projectId);
                const supplier = state.suppliers.find(s => s.id === state.editingOrder.supplierId);
                
                const updates = {
                    projectId: state.editingOrder.projectId,
                    projectName: project?.name || '',
                    supplierId: state.editingOrder.supplierId,
                    supplierName: supplier?.name || '',
                    items: itemsWithSum,
                    totalSum: totalSum,
                    comments: state.editingOrder.comments,
                    deliveryAddress: state.editingOrder.deliveryAddress,
                    orderedBy: state.editingOrder.orderedBy
                };
                
                await db.collection('orders').doc(orderId).update(updates);
                
                state.orders = state.orders.map(o =>
                    o.id === orderId ? { ...o, ...updates } : o
                );
                
                state.editingOrder = null;
                render();
            } catch (error) {
                console.error('Error updating order:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×–×× ×”: ' + error.message);
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×”×–×× ×”?')) return;
            
            try {
                await db.collection('orders').doc(orderId).delete();
                state.orders = state.orders.filter(o => o.id !== orderId);
                render();
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×”×–×× ×”: ' + error.message);
            }
        }

        function calculateOrderTotals() {
            // Auto-calculate sums for order items in the form
            state.newOrder.items = state.newOrder.items.map(item => ({
                ...item,
                sum: item.price ? parseFloat(item.price) : 0
            }));
            render();
        }
        
        // ===== WORK SCHEDULE FUNCTIONS =====
        
        async function loadWorkAssignments() {
            if (!state.user) {
                console.log('Cannot load work assignments: user not authenticated');
                return;
            }
            if (state.loadingAssignments) {
                console.log('Already loading assignments, skipping...');
                return;
            }
            try {
                state.loadingAssignments = true;
                console.log('Loading work assignments...');
                const snapshot = await db.collection('workAssignments').get();
                state.workAssignments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log('Loaded work assignments:', state.workAssignments.length);
                state.assignmentsLoaded = true;
                state.loadingAssignments = false;
                render();
            } catch (error) {
                console.error('Error loading work assignments:', error);
                state.loadingAssignments = false;
                if (state.user) {
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×™×“×•×¨ ×¢×‘×•×“×”: ' + error.message);
                }
            }
        }
        
        async function addWorkAssignment(workerId, projectId, date) {
            try {
                const project = state.allProjects.find(p => p.id === projectId);
                if (!project) {
                    alert('×¤×¨×•×™×§×˜ ×œ× × ××¦×');
                    return;
                }
                
                const assignmentData = {
                    workerId: workerId,
                    projectId: projectId,
                    projectName: project.name,
                    clientId: project.clientId,
                    clientName: project.clientName,
                    date: date, // Store as ISO string: YYYY-MM-DD
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: state.user.uid
                };
                
                const docRef = await db.collection('workAssignments').add(assignmentData);
                console.log('Work assignment added:', docRef.id);
                
                state.workAssignments.push({
                    id: docRef.id,
                    ...assignmentData,
                    createdAt: new Date()
                });
                
                render();
            } catch (error) {
                console.error('Error adding work assignment:', error);
                alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×©×™×‘×•×¥: ' + error.message);
            }
        }
        
        async function deleteWorkAssignment(assignmentId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×©×™×‘×•×¥?')) return;
            
            try {
                await db.collection('workAssignments').doc(assignmentId).delete();
                state.workAssignments = state.workAssignments.filter(a => a.id !== assignmentId);
                render();
            } catch (error) {
                console.error('Error deleting work assignment:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×©×™×‘×•×¥: ' + error.message);
            }
        }

        function addOrderItem() {
            state.newOrder.items.push({ description: '', unit: '×™×—\'', quantity: '', price: '', sum: 0 });
            render();
        }

        function removeOrderItem(index) {
            if (state.newOrder.items.length > 1) {
                state.newOrder.items.splice(index, 1);
                render();
            }
        }

        // ===== PDF GENERATION FUNCTIONS =====
        
        async function uploadPDFTemplate(file) {
            try {
                const storageRef = storage.ref(`templates/order_template.pdf`);
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                state.pdfTemplate = url;
                alert('×ª×‘× ×™×ª PDF ×”×•×¢×œ×ª×” ×‘×”×¦×œ×—×”');
                render();
                return url;
            } catch (error) {
                console.error('Error uploading PDF template:', error);
                alert('×©×’×™××” ×‘×”×¢×œ××ª ×ª×‘× ×™×ª PDF: ' + error.message);
                throw error;
            }
        }

        // Cache for Hebrew font
        let hebrewFontBytes = null;
        
        async function loadHebrewFont() {
            if (hebrewFontBytes) {
                console.log('Using cached Hebrew font');
                return hebrewFontBytes;
            }
            
            try {
                console.log('Fetching Hebrew font (Rubik)...');
                // Rubik Regular with Hebrew support from Google Fonts
                const fontUrl = 'https://fonts.gstatic.com/s/rubik/v28/iJWZBXyIfDnIV5PNhY1KTN7Z-Yh-B4iFWUU.ttf';
                const response = await fetch(fontUrl);
                if (!response.ok) {
                    throw new Error('Failed to fetch Hebrew font');
                }
                hebrewFontBytes = await response.arrayBuffer();
                console.log('Hebrew font loaded successfully');
                return hebrewFontBytes;
            } catch (error) {
                console.error('Error loading Hebrew font:', error);
                throw error;
            }
        }

        async function generateOrderPDF(orderId) {
            try {
                const order = state.orders.find(o => o.id === orderId);
                if (!order) {
                    alert('×”×–×× ×” ×œ× × ××¦××”');
                    return;
                }
                
                // Fetch the PDF template
                let pdfDoc;
                let useTemplate = false;
                
                if (state.pdfTemplate) {
                    try {
                        console.log('Loading PDF template from:', state.pdfTemplate);
                        const response = await fetch(state.pdfTemplate);
                        if (!response.ok) {
                            throw new Error('Failed to fetch template: ' + response.statusText);
                        }
                        const templateBytes = await response.arrayBuffer();
                        console.log('Template bytes loaded:', templateBytes.byteLength);
                        pdfDoc = await PDFLib.PDFDocument.load(templateBytes);
                        useTemplate = true;
                        console.log('âœ… PDF template loaded successfully, pages:', pdfDoc.getPageCount());
                    } catch (error) {
                        console.error('âŒ Error loading template:', error);
                        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×‘× ×™×ª PDF: ' + error.message + '\n\n×™×•×¦×¨ PDF ×œ×œ× ×ª×‘× ×™×ª.');
                        pdfDoc = await PDFLib.PDFDocument.create();
                    }
                } else {
                    // No template uploaded
                    const proceed = confirm('×œ× ×”×•×¢×œ×ª×” ×ª×‘× ×™×ª PDF. ×”×× ×œ×™×¦×•×¨ PDF ×¤×©×•×˜ ×œ×œ× ×œ×•×’×•?');
                    if (!proceed) return;
                    pdfDoc = await PDFLib.PDFDocument.create();
                }
                
                // Get the first page or create one
                let page;
                if (pdfDoc.getPageCount() > 0) {
                    page = pdfDoc.getPage(0);
                } else {
                    page = pdfDoc.addPage([595, 842]); // A4 size
                }
                
                const { width, height } = page.getSize();
                console.log('PDF dimensions:', width, 'x', height);
                
                // Load and embed Hebrew font
                const fontBytes = await loadHebrewFont();
                const font = await pdfDoc.embedFont(fontBytes);
                const boldFont = await pdfDoc.embedFont(fontBytes); // Same font for now, can make bold later
                
                // Helper function to reverse Hebrew text for RTL display
                const reverseHebrewText = (text) => {
                    if (!text) return '';
                    // Reverse the string for RTL display in PDF
                    return text.split('').reverse().join('');
                };
                
                // Helper to clean text but keep Hebrew
                const cleanText = (text) => {
                    if (!text) return '';
                    return text.trim();
                };
                
                // Get supplier contact info
                const supplier = state.suppliers.find(s => s.id === order.supplierId);
                
                // Add order details - Start position adjusted for template with logo/header
                // Assuming template has header in top ~200 points
                let yPosition = height - 180;  // Start below header area
                const fontSize = 11;
                const lineHeight = 18;
                const leftMargin = 40;
                const rightColumn = 320;
                
                // Order number (bold, larger) - Right side
                page.drawText(reverseHebrewText(`×”×–×× ×” ××¡': ${order.orderNumber}`), {
                    x: rightColumn,
                    y: yPosition,
                    size: 14,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight * 1.5;
                
                // Order date - Right side
                page.drawText(reverseHebrewText(`×ª××¨×™×š: ${order.orderDate || new Date().toLocaleDateString('he-IL')}`), {
                    x: rightColumn,
                    y: yPosition,
                    size: fontSize,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight;
                
                // Project name - Right side
                const projectDisplay = order.projectName || `×¤×¨×•×™×§×˜ #${order.projectId.substring(0, 8)}`;
                page.drawText(reverseHebrewText(`×©× ×¤×¨×•×™×§×˜: ${projectDisplay}`), {
                    x: rightColumn,
                    y: yPosition,
                    size: fontSize,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight;
                
                // Supplier name - Right side
                const supplierDisplay = order.supplierName || `×¡×¤×§ #${order.supplierId.substring(0, 8)}`;
                page.drawText(reverseHebrewText(`×©× ×¡×¤×§: ${supplierDisplay}`), {
                    x: rightColumn,
                    y: yPosition,
                    size: fontSize,
                    font: font,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight;
                
                // Supplier contact info - Right side
                if (supplier && supplier.contactName) {
                    page.drawText(reverseHebrewText(`××™×© ×§×©×¨: ${supplier.contactName}`), {
                        x: rightColumn,
                        y: yPosition,
                        size: fontSize,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    yPosition -= lineHeight;
                }
                
                yPosition -= lineHeight;
                
                // Items table header - RTL order
                const colDesc = leftMargin;
                const colQty = 220;
                const colUnit = 280;
                const colPrice = 340;
                const colSum = 420;
                const rightMargin = width - 40;
                
                page.drawText(reverseHebrewText('×ª×™××•×¨'), {
                    x: colDesc,
                    y: yPosition,
                    size: fontSize,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                page.drawText(reverseHebrewText('×›××•×ª'), {
                    x: colQty,
                    y: yPosition,
                    size: fontSize,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                page.drawText(reverseHebrewText('×™×—×™×“×”'), {
                    x: colUnit,
                    y: yPosition,
                    size: fontSize,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                page.drawText(reverseHebrewText('××—×™×¨'), {
                    x: colPrice,
                    y: yPosition,
                    size: fontSize,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                page.drawText(reverseHebrewText('×¡×”"×›'), {
                    x: colSum,
                    y: yPosition,
                    size: fontSize,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight * 0.5;
                
                // Draw line under header
                page.drawLine({
                    start: { x: leftMargin, y: yPosition },
                    end: { x: rightMargin, y: yPosition },
                    thickness: 1,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight * 0.8;
                
                // Items
                for (const item of order.items) {
                    if (yPosition < 120) {
                        // Add new page if needed
                        page = pdfDoc.addPage([595, 842]);
                        yPosition = height - 50;
                    }
                    
                    // Description - reverse if Hebrew
                    const descText = item.description || `×¤×¨×™×˜ ${order.items.indexOf(item) + 1}`;
                    page.drawText(reverseHebrewText(descText.substring(0, 30)), {
                        x: colDesc,
                        y: yPosition,
                        size: fontSize,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Quantity
                    page.drawText(String(item.quantity || 1), {
                        x: colQty,
                        y: yPosition,
                        size: fontSize,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Unit - keep Hebrew units
                    const unitDisplay = reverseHebrewText(item.unit || '×™×—\'');
                    page.drawText(unitDisplay, {
                        x: colUnit,
                        y: yPosition,
                        size: fontSize,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Price
                    page.drawText(item.price.toFixed(2), {
                        x: colPrice,
                        y: yPosition,
                        size: fontSize,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    
                    // Sum
                    page.drawText(item.sum.toFixed(2), {
                        x: colSum,
                        y: yPosition,
                        size: fontSize,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    yPosition -= lineHeight;
                }
                
                yPosition -= lineHeight * 0.5;
                
                // Draw line before total
                page.drawLine({
                    start: { x: colPrice - 10, y: yPosition },
                    end: { x: rightMargin, y: yPosition },
                    thickness: 1,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight * 0.8;
                
                // Total
                page.drawText(reverseHebrewText(`×¡×”"×›: â‚ª${order.totalSum.toFixed(2)}`), {
                    x: colPrice,
                    y: yPosition,
                    size: 12,
                    font: boldFont,
                    color: PDFLib.rgb(0, 0, 0)
                });
                yPosition -= lineHeight * 2;
                
                // Additional info at the bottom - Right aligned
                if (order.orderedBy) {
                    page.drawText(reverseHebrewText(`×©× ×”××–××™×Ÿ: ${order.orderedBy}`), {
                        x: rightColumn,
                        y: yPosition,
                        size: fontSize - 1,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    yPosition -= lineHeight;
                }
                
                if (order.deliveryAddress) {
                    page.drawText(reverseHebrewText(`×›×ª×•×‘×ª ××©×œ×•×—: ${order.deliveryAddress.substring(0, 40)}`), {
                        x: rightColumn,
                        y: yPosition,
                        size: fontSize - 1,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    yPosition -= lineHeight;
                }
                
                if (order.comments) {
                    page.drawText(reverseHebrewText(`×”×¢×¨×•×ª: ${order.comments.substring(0, 40)}`), {
                        x: rightColumn,
                        y: yPosition,
                        size: fontSize - 1,
                        font: font,
                        color: PDFLib.rgb(0, 0, 0)
                    });
                    yPosition -= lineHeight;
                }
                
                // Save and download
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `Order_${order.orderNumber.replace('/', '-')}_${order.projectName}.pdf`;
                link.click();
                
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª PDF: ' + error.message);
            }
        }

        // ===== OCR FUNCTIONS =====
        
        async function processInvoiceWithOCR(file) {
            state.ocrProcessing = true;
            state.ocrProgress = 0;
            render();
            
            try {
                console.log('Starting OCR processing...');
                
                // Create Tesseract worker
                const worker = await Tesseract.createWorker('heb+eng', 1, {
                    logger: (m) => {
                        if (m.status === 'recognizing text') {
                            state.ocrProgress = Math.round(m.progress * 100);
                            render();
                        }
                    }
                });
                
                // Perform OCR
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();
                
                console.log('OCR Text extracted:', text);
                
                // Parse the extracted text
                const invoiceData = parseInvoiceText(text);
                
                // Auto-fill the form
                if (invoiceData.supplier) {
                    state.newInvoice.supplier = invoiceData.supplier;
                }
                if (invoiceData.date) {
                    state.newInvoice.date = invoiceData.date;
                }
                if (invoiceData.items && invoiceData.items.length > 0) {
                    state.newInvoice.items = invoiceData.items;
                }
                if (invoiceData.total) {
                    // If we found a total but no items, create one item with the total
                    if (state.newInvoice.items.length === 1 && !state.newInvoice.items[0].amount) {
                        state.newInvoice.items[0].amount = invoiceData.total;
                        state.newInvoice.items[0].description = '×—×©×‘×•× ×™×ª';
                    }
                }
                
                state.ocrProcessing = false;
                state.showOcrUpload = false;
                render();
                
                alert('âœ… × ×ª×•× ×™ ×”×—×©×‘×•× ×™×ª ×—×•×œ×¦×• ×‘×”×¦×œ×—×”! ×‘×“×•×§ ×•×”×©×œ× ××ª ×”×¤×¨×˜×™×.');
                
            } catch (error) {
                console.error('OCR Error:', error);
                state.ocrProcessing = false;
                render();
                alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×ª××•× ×”: ' + error.message);
            }
        }
        
        function parseInvoiceText(text) {
            const invoiceData = {
                supplier: '',
                date: '',
                items: [],
                total: ''
            };
            
            // Split text into lines
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            // Try to find supplier name (usually one of the first lines)
            if (lines.length > 0) {
                // Look for company name patterns
                for (let i = 0; i < Math.min(5, lines.length); i++) {
                    const line = lines[i];
                    // Skip lines that look like phone numbers or addresses
                    if (!line.match(/\d{2,3}-\d{7}/) && !line.match(/^[\d\s-]+$/) && line.length > 3) {
                        invoiceData.supplier = line;
                        break;
                    }
                }
            }
            
            // Try to find date (Israeli format DD/MM/YYYY or DD.MM.YYYY)
            const dateRegex = /(\d{1,2})[\.\/](\d{1,2})[\.\/](\d{2,4})/;
            for (const line of lines) {
                const dateMatch = line.match(dateRegex);
                if (dateMatch) {
                    const day = dateMatch[1].padStart(2, '0');
                    const month = dateMatch[2].padStart(2, '0');
                    let year = dateMatch[3];
                    if (year.length === 2) {
                        year = '20' + year;
                    }
                    invoiceData.date = `${year}-${month}-${day}`;
                    break;
                }
            }
            
            // Try to find amounts (numbers with â‚ª or numbers followed by currency indicators)
            const amountRegex = /[\d,]+\.?\d*\s*â‚ª|â‚ª\s*[\d,]+\.?\d*/g;
            const amounts = [];
            
            for (const line of lines) {
                const matches = line.match(amountRegex);
                if (matches) {
                    matches.forEach(match => {
                        const cleanAmount = match.replace(/[â‚ª,\s]/g, '');
                        const amount = parseFloat(cleanAmount);
                        if (amount > 0) {
                            amounts.push(amount);
                        }
                    });
                }
            }
            
            // If we found amounts, use the largest as total and create items
            if (amounts.length > 0) {
                amounts.sort((a, b) => b - a);
                invoiceData.total = amounts[0].toString();
                
                // Create items from found amounts (excluding the total)
                if (amounts.length > 1) {
                    invoiceData.items = amounts.slice(1, 4).map((amount, index) => ({
                        description: `×¤×¨×™×˜ ${index + 1}`,
                        amount: amount.toString(),
                        category: '×©×•× ×•×ª'
                    }));
                }
            }
            
            return invoiceData;
        }
        
        function handleOCRFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×” (JPG, PNG, ×•×›×•\')');
                return;
            }
            
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('×’×•×“×œ ×”×§×•×‘×¥ ×—×•×¨×’ ×-10MB');
                return;
            }
            
            processInvoiceWithOCR(file);
        }
        
        // ===== OCR FUNCTIONS =====
        
        async function processInvoiceWithOCR(file, method = 'tesseract') {
            state.ocrProcessing = true;
            state.ocrProgress = 0;
            render();
            
            try {
                console.log('Starting OCR processing with method:', method);
                let extractedText;
                
                if (method === 'google') {
                    extractedText = await processWithGoogleVision(file);
                } else {
                    extractedText = await processWithTesseract(file);
                }
                
                console.log('Extracted text:', extractedText);
                const invoiceData = parseInvoiceText(extractedText);
                console.log('Parsed invoice data:', invoiceData);
                
                state.ocrResults = invoiceData;
                state.ocrProcessing = false;
                render();
            } catch (error) {
                console.error('OCR Error:', error);
                state.ocrProcessing = false;
                render();
                alert('×©×’×™××” ×‘×¡×¨×™×§×ª ×”×—×©×‘×•× ×™×ª: ' + error.message);
            }
        }
        
        async function processWithTesseract(file) {
            console.log('Processing with Tesseract.js...');
            
            const worker = await Tesseract.createWorker('heb+eng', 1, {
                logger: (m) => {
                    if (m.status === 'recognizing text') {
                        state.ocrProgress = Math.round(m.progress * 100);
                        render();
                    }
                }
            });
            
            const { data: { text } } = await worker.recognize(file);
            await worker.terminate();
            return text;
        }
        
        async function processWithGoogleVision(file) {
            console.log('Processing with Google Cloud Vision...');
            
            const GOOGLE_VISION_API_KEY = 'YOUR_API_KEY_HERE';
            if (GOOGLE_VISION_API_KEY === 'YOUR_API_KEY_HERE') {
                throw new Error('Google Vision API key not configured');
            }
            
            const base64 = await fileToBase64(file);
            
            const response = await fetch(
                `https://vision.googleapis.com/v1/images:annotate?key=${GOOGLE_VISION_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requests: [{
                            image: { content: base64 },
                            features: [{ type: 'DOCUMENT_TEXT_DETECTION' }]
                        }]
                    })
                }
            );
            
            const data = await response.json();
            
            if (data.responses[0].error) {
                throw new Error(data.responses[0].error.message);
            }
            
            return data.responses[0].fullTextAnnotation?.text || '';
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        function parseInvoiceText(text) {
            console.log('=== OCR EXTRACTED TEXT ===');
            console.log(text);
            console.log('=========================');
            
            const invoiceData = {
                supplier: '',
                invoiceNumber: '',
                date: '',
                items: [],
                total: ''
            };
            
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            // Extract supplier (first meaningful line)
            for (let i = 0; i < Math.min(5, lines.length); i++) {
                const line = lines[i];
                if (!line.match(/\d{2,3}-\d{7}/) && !line.match(/^[\d\s-]+$/) && line.length > 3) {
                    invoiceData.supplier = line;
                    break;
                }
            }
            
            // Extract invoice number - look for various patterns
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Try single-line patterns first
                const singleLinePatterns = [
                    /×—×©×‘×•× ×™×ª\s+××¡\s+××¡['×³]?\s*:?\s*(\d+)/i,  // "×—×©×‘×•× ×™×ª ××¡ ××¡' : 12198"
                    /××¡['×³]?\s*:?\s*(\d+)/i,                   // "××¡' : 12198"
                    /invoice\s*#?\s*:?\s*(\d+)/i,             // "Invoice # 12198" or "Invoice: 12198"
                    /××¡×¤×¨\s+×—×©×‘×•× ×™×ª\s*:?\s*(\d+)/i,          // "××¡×¤×¨ ×—×©×‘×•× ×™×ª: 12198"
                ];
                
                for (const pattern of singleLinePatterns) {
                    const match = line.match(pattern);
                    if (match && match[1]) {
                        invoiceData.invoiceNumber = match[1];
                        console.log('âœ… Invoice number extracted (single line):', match[1]);
                        break;
                    }
                }
                
                if (invoiceData.invoiceNumber) break;
                
                // Check if this line contains "×—×©×‘×•× ×™×ª ××¡ ××¡'" and next line has a number
                if (line.match(/×—×©×‘×•× ×™×ª\s+××¡\s+××¡['×³]?\s*:?\s*$/i) && i + 1 < lines.length) {
                    const nextLine = lines[i + 1];
                    const numberMatch = nextLine.match(/^\s*(\d+)\s*$/);
                    if (numberMatch) {
                        invoiceData.invoiceNumber = numberMatch[1];
                        console.log('âœ… Invoice number extracted (multi-line):', numberMatch[1]);
                        break;
                    }
                }
                
                // Also check for "××¡'" followed by number on next line
                if (line.match(/××¡['×³]?\s*:?\s*$/i) && i + 1 < lines.length) {
                    const nextLine = lines[i + 1];
                    const numberMatch = nextLine.match(/^\s*(\d+)\s*$/);
                    if (numberMatch) {
                        invoiceData.invoiceNumber = numberMatch[1];
                        console.log('âœ… Invoice number extracted (multi-line):', numberMatch[1]);
                        break;
                    }
                }
            }
            
            // Extract date - look for pattern like "×ª××¨×™×š : 28/09/2025"
            const datePattern = /(\d{1,2})[\.\/\-](\d{1,2})[\.\/\-](\d{4})/;
            
            for (const line of lines) {
                const dateMatch = line.match(datePattern);
                if (dateMatch) {
                    const day = dateMatch[1].padStart(2, '0');
                    const month = dateMatch[2].padStart(2, '0');
                    const year = dateMatch[3];
                    
                    invoiceData.date = `${year}-${month}-${day}`;
                    break;
                }
            }
            
            // Find table section - look for keywords that indicate the items table
            const tableKeywords = ['×¤×¨×™×˜', '×›××•×ª', '××—×™×¨', '×¡×”"×›', '××¡ ×©×•×¨×”'];
            let tableStartIndex = -1;
            let tableEndIndex = lines.length;
            
            // Find start of table (line with column headers or first item)
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const hasTableKeyword = tableKeywords.some(keyword => line.includes(keyword));
                if (hasTableKeyword) {
                    tableStartIndex = i;
                    break;
                }
            }
            
            // Find end of table (usually at "×¡×”"×›:" or "×¡×”"×› ×œ×¤× ×™ ××¢"×")
            for (let i = tableStartIndex + 1; i < lines.length; i++) {
                const line = lines[i];
                if (line.match(/×¡×”["']×›\s*:/) || line.includes('×¡×”"×› ×œ×¤× ×™ ××¢"×') || line.includes('×œ×ª×©×œ×•×')) {
                    tableEndIndex = i;
                    break;
                }
            }
            
            console.log(`Table section: lines ${tableStartIndex} to ${tableEndIndex}`);
            
            // Extract items from table section only
            const tableLines = tableStartIndex >= 0 ? lines.slice(tableStartIndex, tableEndIndex) : lines;
            
            // Pattern to match large amounts (likely item totals) - must have comma or 3+ digits before decimal
            const itemAmountPattern = /(\d{1,3}(?:,\d{3})+(?:\.\d{2})?|\d{3,}(?:\.\d{2})?)/g;
            
            const items = [];
            const processedAmounts = new Set(); // Track amounts we've already used
            
            for (let i = 0; i < tableLines.length; i++) {
                const line = tableLines[i];
                
                // Skip header lines
                if (tableKeywords.some(keyword => line.includes(keyword)) && !line.match(/\d{3,}/)) {
                    continue;
                }
                
                // Look for amounts in this line
                const amounts = [...line.matchAll(itemAmountPattern)].map(match => {
                    const cleanAmount = match[1].replace(/,/g, '');
                    return parseFloat(cleanAmount);
                }).filter(amount => {
                    // Filter for reasonable item amounts (100 to 100,000)
                    return amount >= 100 && amount < 100000 && !processedAmounts.has(amount);
                });
                
                if (amounts.length > 0) {
                    // Usually the last amount in the line is the total for that item
                    const itemTotal = amounts[amounts.length - 1];
                    processedAmounts.add(itemTotal);
                    
                    // Extract description - remove all numbers and symbols
                    let description = line
                        .replace(/\d+[\.,]\d+/g, '') // Remove decimals
                        .replace(/\d{3,}/g, '')       // Remove large numbers
                        .replace(/[\d,\.â‚ª\s×©"×—]+$/g, '') // Remove trailing numbers
                        .replace(/^\d+\s*/, '')       // Remove leading numbers (item number)
                        .trim();
                    
                    // Clean up common OCR artifacts
                    description = description
                        .replace(/[â€â€]/g, '') // Remove RTL marks
                        .replace(/\s+/g, ' ') // Normalize spaces
                        .trim();
                    
                    if (description.length < 3) {
                        description = `×¤×¨×™×˜ ${items.length + 1}`;
                    }
                    
                    items.push({
                        description: description.substring(0, 100),
                        amount: itemTotal.toString(),
                        category: '×©×•× ×•×ª'
                    });
                }
            }
            
            console.log('Extracted items from table:', items);
            
            // Extract total (×¡×”"×› ×œ×ª×©×œ×•×)
            for (const line of lines) {
                if (line.includes('×œ×ª×©×œ×•×') || line.includes('×¡×”"×› ×œ×ª×©×œ×•×')) {
                    const totalMatch = line.match(/(\d{1,3}(?:,\d{3})+(?:\.\d{2})?|\d{3,}(?:\.\d{2})?)/);
                    if (totalMatch) {
                        invoiceData.total = totalMatch[1].replace(/,/g, '');
                        break;
                    }
                }
            }
            
            invoiceData.items = items.length > 0 ? items : [{
                description: '',
                amount: '',
                category: '×©×•× ×•×ª'
            }];
            
            console.log('Parsed invoice data:', invoiceData);
            
            return invoiceData;
        }
        
        async function extractTextFromPDF(file) {
            try {
                console.log('Starting PDF text extraction...');
                
                // Check if PDF.js is loaded
                if (typeof pdfjsLib === 'undefined') {
                    console.error('âŒ PDF.js library not loaded!');
                    return '';
                }
                console.log('âœ… PDF.js loaded, version:', pdfjsLib.version);
                
                const arrayBuffer = await file.arrayBuffer();
                console.log('ArrayBuffer loaded, size:', arrayBuffer.byteLength);
                
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                console.log('PDF loaded, pages:', pdf.numPages);
                
                let structuredText = [];
                
                // Extract text with position information
                for (let pageNum = 1; pageNum <= Math.min(pdf.numPages, 3); pageNum++) {
                    console.log(`Extracting page ${pageNum}...`);
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    console.log('Text items found:', textContent?.items?.length || 0);
                    
                    // Group text by vertical position (Y coordinate)
                    // This helps identify rows in tables
                    const lineGroups = new Map();
                    
                    if (textContent && textContent.items && Array.isArray(textContent.items)) {
                        textContent.items.forEach(item => {
                            if (item && item.transform && Array.isArray(item.transform) && item.str) {
                                const y = Math.round(item.transform[5]); // Y coordinate
                                const text = item.str.trim();
                                
                                if (text) {
                                    if (!lineGroups.has(y)) {
                                        lineGroups.set(y, []);
                                    }
                                    lineGroups.get(y).push({
                                        text: text,
                                        x: item.transform[4] // X coordinate
                                    });
                                }
                            }
                        });
                    }
                    
                    // Sort lines by Y position (top to bottom)
                    const sortedLines = Array.from(lineGroups.entries())
                        .sort((a, b) => b[0] - a[0]) // PDF coordinates go bottom-up
                        .map(([y, items]) => {
                            // Sort items in each line by X position (right to left for Hebrew)
                            const sortedItems = items.sort((a, b) => b.x - a.x);
                            return sortedItems.map(item => item.text).join(' ');
                        });
                    
                    console.log(`Page ${pageNum} extracted ${sortedLines.length} lines`);
                    structuredText.push(...sortedLines);
                }
                
                const fullText = structuredText.join('\n');
                
                console.log('=== EXTRACTED STRUCTURED TEXT FROM PDF ===');
                console.log(fullText);
                console.log('Text length:', fullText.length);
                console.log('==========================================');
                
                return fullText || ''; // Always return a string
            } catch (error) {
                console.error('PDF text extraction error:', error);
                console.error('Error details:', error.message);
                // Return empty string instead of throwing - let caller handle it
                return '';
            }
        }
        
        async function convertPDFToImage(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1); // Get first page
                
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;
                
                // Convert canvas to blob
                return new Promise((resolve) => {
                    canvas.toBlob((blob) => {
                        resolve(new File([blob], 'invoice.png', { type: 'image/png' }));
                    }, 'image/png');
                });
            } catch (error) {
                console.error('PDF conversion error:', error);
                throw new Error('×©×’×™××” ×‘×”××¨×ª PDF ×œ×ª××•× ×”');
            }
        }
        
        async function handleOCRUpload(event) {
            try {
                console.log('handleOCRUpload called');
                const file = event.target.files[0];
                if (!file) {
                    console.log('No file selected');
                    return;
                }
                console.log('File selected:', file.name, file.type, file.size);
                
                await processOCRFile(file);
            } catch (error) {
                console.error('Error in handleOCRUpload:', error);
                alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥: ' + error.message);
            }
        }
        
        async function processOCRFile(file) {
            // Validate file type
            const isImage = file.type.startsWith('image/');
            const isPDF = file.type === 'application/pdf';
            
            if (!isImage && !isPDF) {
                alert('×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×” ××• PDF');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                alert('×’×•×“×œ ×”×§×•×‘×¥ ×—×•×¨×’ ×-10MB');
                return;
            }
            
            try {
                // For PDFs, parse directly without cropping
                if (isPDF) {
                    state.ocrProcessing = true;
                    state.ocrProgress = 30;
                    render();
                    
                    try {
                        console.log('ğŸ“„ Attempting PDF text extraction...');
                        const extractedText = await extractTextFromPDF(file);
                        console.log('ğŸ“ Extracted text length:', extractedText ? extractedText.length : 0);
                        
                        // Check if we got meaningful text (not a scanned PDF)
                        if (extractedText && extractedText.trim().length > 50) {
                            console.log('âœ… PDF has machine-readable text, parsing directly');
                            state.ocrProgress = 100;
                            render();
                            
                            // Parse the extracted text
                            const invoiceData = parseInvoiceText(extractedText);
                            
                            // Save the original PDF file as attachment
                            invoiceData.originalFile = file;
                            
                            state.ocrResults = invoiceData;
                            state.ocrProcessing = false;
                            render();
                            return; // Done! Skip crop modal
                        } else {
                            console.log('âš ï¸ PDF appears to be scanned (no/little text found), converting to image for OCR...');
                            console.log('Extracted text was:', extractedText);
                            // Convert scanned PDF to image and continue to crop modal
                            state.ocrProgress = 50;
                            render();
                            const imageFile = await convertPDFToImage(file);
                            state.pendingOCRFile = imageFile;
                        }
                    } catch (pdfError) {
                        console.error('âŒ PDF text extraction error:', pdfError);
                        console.error('Error message:', pdfError.message);
                        console.error('Error stack:', pdfError.stack);
                        // Convert to image and continue to crop modal
                        state.ocrProgress = 50;
                        render();
                        const imageFile = await convertPDFToImage(file);
                        state.pendingOCRFile = imageFile;
                    }
                    
                    state.ocrProcessing = false;
                } else {
                    // For images, prepare for crop
                    state.pendingOCRFile = file;
                }
                
                // Show crop modal only for images or scanned PDFs
                state.showCropModal = true;
                render();
                
                // Initialize cropper after render
                setTimeout(() => initializeCropper(state.pendingOCRFile), 100);
            } catch (error) {
                state.ocrProcessing = false;
                render();
                alert(error.message);
            }
        }
        
        function initializeCropper(file) {
            const img = document.getElementById('crop-image');
            if (!img) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
                
                // Destroy existing cropper if any
                if (state.cropperInstance) {
                    state.cropperInstance.destroy();
                }
                
                // Initialize new cropper
                state.cropperInstance = new Cropper(img, {
                    viewMode: 1,
                    aspectRatio: NaN, // Free aspect ratio
                    autoCropArea: 1,
                    movable: true,
                    zoomable: true,
                    rotatable: true,
                    scalable: true,
                    guides: true,
                    highlight: true,
                    background: false,
                    responsive: true,
                    restore: true
                });
            };
            reader.readAsDataURL(file);
        }
        
        async function applyCropAndProcess() {
            if (!state.cropperInstance) return;
            
            // Get cropped canvas
            const canvas = state.cropperInstance.getCroppedCanvas({
                maxWidth: 4096,
                maxHeight: 4096,
                imageSmoothingEnabled: true,
                imageSmoothingQuality: 'high'
            });
            
            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
                const croppedFile = new File([blob], 'cropped-invoice.png', { type: 'image/png' });
                
                // Close crop modal
                closeCropModal();
                
                // Process with OCR
                processInvoiceWithOCR(croppedFile, state.ocrMethod);
            }, 'image/png', 0.95);
        }
        
        function skipCropAndProcess() {
            const file = state.pendingOCRFile;
            closeCropModal();
            processInvoiceWithOCR(file, state.ocrMethod);
        }
        
        function closeCropModal() {
            if (state.cropperInstance) {
                state.cropperInstance.destroy();
                state.cropperInstance = null;
            }
            state.showCropModal = false;
            state.pendingOCRFile = null;
            render();
        }
        
        // Drag and drop handlers
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.dataTransfer.dropEffect = 'copy';
            
            const dropZone = event.currentTarget;
            dropZone.classList.add('bg-blue-100', 'border-blue-400');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = event.currentTarget;
            dropZone.classList.remove('bg-blue-100', 'border-blue-400');
        }
        
        async function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const dropZone = event.currentTarget;
            dropZone.classList.remove('bg-blue-100', 'border-blue-400');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                await processOCRFile(files[0]);
            }
        }
        
        async function approveOCRResults() {
            if (!state.ocrResults) return;
            
            state.newInvoice.supplier = state.ocrResults.supplier;
            state.newInvoice.invoiceNumber = state.ocrResults.invoiceNumber || '';
            state.newInvoice.date = state.ocrResults.date;
            state.newInvoice.items = state.ocrResults.items;
            
            // Add the original file to attachments for preview (will be uploaded when saving invoice)
            if (state.ocrResults.originalFile) {
                try {
                    const file = state.ocrResults.originalFile;
                    
                    // Convert file to data URL for preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.newInvoice.attachments = [{
                            name: file.name,
                            data: e.target.result,
                            type: file.type
                        }];
                        render();
                    };
                    reader.readAsDataURL(file);
                    
                    console.log('âœ… PDF file added to attachments');
                } catch (error) {
                    console.error('Error processing PDF:', error);
                    alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥: ' + error.message);
                }
            }
            
            state.ocrResults = null;
            render();
        }
        
        function cancelOCRResults() {
            state.ocrResults = null;
            render();
        }
        
        // ===== INVOICE FUNCTIONS =====
        
        async function loadInvoices(projectId) {
            try {
                const snapshot = await db.collection('invoices')
                    .where('projectId', '==', projectId)
                    .get();
                
                const invoices = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                invoices.sort((a, b) => new Date(b.date) - new Date(a.date));
                return invoices;
            } catch (error) {
                console.error('Error loading invoices:', error);
                return [];
            }
        }

        async function addInvoice() {
            if (!state.newInvoice.supplier || !state.selectedProject) {
                alert('×™×© ×œ×”×–×™×Ÿ ×¡×¤×§');
                return;
            }
            
            const validItems = state.newInvoice.items.filter(item => item.amount && parseFloat(item.amount) > 0);
            if (validItems.length === 0) {
                alert('×™×© ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“ ×¢× ×¡×›×•×');
                return;
            }
            
            try {
                // Upload files with authentication
                const uploadedFiles = [];
                for (const file of state.newInvoice.attachments) {
                    const storageRef = storage.ref(`invoices/${state.selectedProject.id}/${Date.now()}_${file.name}`);
                    await storageRef.putString(file.data, 'data_url');
                    const downloadURL = await getAuthenticatedDownloadURL(storageRef);
                    uploadedFiles.push({
                        name: file.name,
                        url: downloadURL,
                        type: file.type
                    });
                }
                
                // Add invoices
                const batch = db.batch();
                validItems.forEach(item => {
                    const invoiceRef = db.collection('invoices').doc();
                    batch.set(invoiceRef, {
                        projectId: state.selectedProject.id,
                        supplier: state.newInvoice.supplier,
                        invoiceNumber: state.newInvoice.invoiceNumber || '',
                        amount: parseFloat(item.amount),
                        date: state.newInvoice.date,
                        description: item.description,
                        category: item.category,
                        attachments: uploadedFiles,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await batch.commit();
                
                // Reload invoices
                const invoices = await loadInvoices(state.selectedProject.id);
                state.selectedProject.invoices = invoices;
                
                state.newInvoice = {
                    supplier: '',
                    date: new Date().toISOString().split('T')[0],
                    items: [{ description: '', amount: '', category: '×©×•× ×•×ª' }],
                    attachments: []
                };
                state.showNewInvoice = false;
                render();
            } catch (error) {
                console.error('Error adding invoice:', error);
                alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×—×©×‘×•× ×™×ª: ' + error.message);
            }
        }

        async function deleteInvoice(invoiceId) {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×”×—×©×‘×•× ×™×ª?')) return;
            
            try {
                await db.collection('invoices').doc(invoiceId).delete();
                const invoices = await loadInvoices(state.selectedProject.id);
                state.selectedProject.invoices = invoices;
                render();
            } catch (error) {
                console.error('Error deleting invoice:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×—×©×‘×•× ×™×ª: ' + error.message);
            }
        }
        
        async function deleteWholeInvoice(supplier, invoiceNumber) {
            const confirmMessage = invoiceNumber ? 
                `×”×× ×œ××—×•×§ ××ª ×›×œ ×”×—×©×‘×•× ×™×ª ××¡×¤×¨ ${invoiceNumber} ×${supplier}?` :
                `×”×× ×œ××—×•×§ ××ª ×›×œ ×”×—×©×‘×•× ×™×ª ×${supplier}?`;
                
            if (!confirm(confirmMessage)) return;
            
            try {
                // Find all invoice items with matching supplier and invoice number
                const invoicesToDelete = state.selectedProject.invoices.filter(inv => 
                    inv.supplier === supplier && (inv.invoiceNumber || '') === invoiceNumber
                );
                
                if (invoicesToDelete.length === 0) {
                    alert('×œ× × ××¦××• ×¤×¨×™×˜×™× ×œ××—×™×§×”');
                    return;
                }
                
                // Delete all items
                const batch = db.batch();
                invoicesToDelete.forEach(invoice => {
                    const docRef = db.collection('invoices').doc(invoice.id);
                    batch.delete(docRef);
                });
                
                await batch.commit();
                
                // Reload invoices
                const invoices = await loadInvoices(state.selectedProject.id);
                state.selectedProject.invoices = invoices;
                render();
                
                console.log(`âœ… Deleted ${invoicesToDelete.length} invoice items`);
            } catch (error) {
                console.error('Error deleting whole invoice:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×—×©×‘×•× ×™×ª: ' + error.message);
            }
        }

        function startEditInvoice(invoice) {
            state.editingInvoice = {
                id: invoice.id,
                supplier: invoice.supplier,
                amount: invoice.amount,
                date: invoice.date,
                description: invoice.description || '',
                category: invoice.category || '×©×•× ×•×ª',
                attachments: invoice.attachments || []
            };
            state.showNewInvoice = false;
            render();
        }

        async function saveEditInvoice() {
            if (!state.editingInvoice.supplier || !state.editingInvoice.amount) return;
            
            try {
                const updates = {
                    supplier: state.editingInvoice.supplier,
                    amount: parseFloat(state.editingInvoice.amount),
                    date: state.editingInvoice.date,
                    description: state.editingInvoice.description,
                    category: state.editingInvoice.category,
                    attachments: state.editingInvoice.attachments
                };
                
                await db.collection('invoices').doc(state.editingInvoice.id).update(updates);
                
                const invoices = await loadInvoices(state.selectedProject.id);
                state.selectedProject.invoices = invoices;
                
                state.editingInvoice = null;
                render();
            } catch (error) {
                console.error('Error updating invoice:', error);
                alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×—×©×‘×•× ×™×ª: ' + error.message);
            }
        }

        function handleEditFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Upload to storage with authentication
                        const storageRef = storage.ref(`invoices/${state.selectedProject.id}/${Date.now()}_${file.name}`);
                        await storageRef.putString(e.target.result, 'data_url');
                        const downloadURL = await getAuthenticatedDownloadURL(storageRef);
                        
                        state.editingInvoice.attachments.push({
                            name: file.name,
                            url: downloadURL,
                            type: file.type
                        });
                        render();
                    } catch (error) {
                        console.error('Error uploading file:', error);
                        alert('×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥');
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function removeEditAttachment(index) {
            state.editingInvoice.attachments.splice(index, 1);
            render();
        }

        // ===== HELPER FUNCTIONS =====
        
        function calculateTotals(project) {
            // Calculate expenses from orders
            const projectOrders = state.orders ? state.orders.filter(o => o.projectId === project.id) : [];
            const ordersExpenses = projectOrders.reduce((sum, order) => sum + (order.totalSum || 0), 0);
            
            // Calculate worker expenses from work assignments (×¡×™×“×•×¨ ×¢×‘×•×“×”)
            const projectWorkAssignments = state.workAssignments ? state.workAssignments.filter(a => a.projectId === project.id) : [];
            const workerExpensesTotal = projectWorkAssignments.reduce((sum, assignment) => {
                const dailyRate = state.workerDailyRates[assignment.workerId] || 0;
                return sum + dailyRate;
            }, 0);
            
            // Total expenses
            const totalExpenses = ordersExpenses + workerExpensesTotal;
            const profit = (project.revenue || 0) - totalExpenses;
            const profitMargin = project.revenue > 0 ? (profit / project.revenue) * 100 : 0;
            
            return { 
                totalExpenses, 
                ordersExpenses, 
                workerExpensesTotal, 
                profit, 
                profitMargin 
            };
        }

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.newInvoice.attachments.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        size: file.size
                    });
                    render();
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Get authenticated download URL for files
        async function getAuthenticatedDownloadURL(storageRef) {
            try {
                // Get the download URL with authentication
                const url = await storageRef.getDownloadURL();
                return url;
            } catch (error) {
                console.error('Error getting download URL:', error);
                throw error;
            }
        }

        function removeAttachment(index) {
            state.newInvoice.attachments.splice(index, 1);
            render();
        }

        function addInvoiceItem() {
            state.newInvoice.items.push({ description: '', amount: '', category: '×©×•× ×•×ª' });
            render();
        }

        function removeInvoiceItem(index) {
            if (state.newInvoice.items.length > 1) {
                state.newInvoice.items.splice(index, 1);
                render();
            }
        }

        function updateInvoiceItem(index, field, value) {
            state.newInvoice.items[index][field] = value;
        }

        // ===== ESTIMATE FILE FUNCTIONS =====
        
        function handleEstimateFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/pdf') {
                alert('×¨×§ ×§×‘×¦×™ PDF ××•×ª×¨×™× ×œ××•××“×Ÿ');
                return;
            }
            
            // Determine which project to update
            const projectId = state.selectedProject?.id || state.editingProject?.id;
            if (!projectId) {
                alert('×©×’×™××”: ×œ× × ××¦× ×¤×¨×•×™×§×˜ ×œ×¢×“×›×•×Ÿ');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    // Upload to storage with authentication
                    const storageRef = storage.ref(`estimates/${projectId}/${Date.now()}_${file.name}`);
                    await storageRef.putString(e.target.result, 'data_url');
                    const downloadURL = await getAuthenticatedDownloadURL(storageRef);
                    
                    // Update project with estimate file
                    await db.collection('projects').doc(projectId).update({
                        estimateFile: {
                            name: file.name,
                            url: downloadURL,
                            uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    });
                    
                    // Update local state
                    const estimateFileData = {
                        name: file.name,
                        url: downloadURL,
                        uploadedAt: new Date()
                    };
                    
                    // Update selected project if it exists
                    if (state.selectedProject && state.selectedProject.id === projectId) {
                        state.selectedProject.estimateFile = estimateFileData;
                    }
                    
                    // Update editing project if it exists
                    if (state.editingProject && state.editingProject.id === projectId) {
                        state.editingProject.estimateFile = estimateFileData;
                    }
                    
                    // Update projects list
                    const projectIndex = state.projects.findIndex(p => p.id === projectId);
                    if (projectIndex !== -1) {
                        state.projects[projectIndex].estimateFile = estimateFileData;
                    }
                    
                    render();
                    alert('×§×•×‘×¥ ×”××•××“×Ÿ ×”×•×¢×œ×” ×‘×”×¦×œ×—×”');
                } catch (error) {
                    console.error('Error uploading estimate file:', error);
                    alert('×©×’×™××” ×‘×”×¢×œ××ª ×§×•×‘×¥ ×”××•××“×Ÿ: ' + error.message);
                }
            };
            reader.readAsDataURL(file);
        }
        
        function removeEstimateFile() {
            if (!confirm('×”×× ×œ××—×•×§ ××ª ×§×•×‘×¥ ×”××•××“×Ÿ?')) return;
            
            // Determine which project to update
            const projectId = state.selectedProject?.id || state.editingProject?.id;
            if (!projectId) {
                alert('×©×’×™××”: ×œ× × ××¦× ×¤×¨×•×™×§×˜ ×œ×¢×“×›×•×Ÿ');
                return;
            }
            
            try {
                // Remove from database
                db.collection('projects').doc(projectId).update({
                    estimateFile: firebase.firestore.FieldValue.delete()
                });
                
                // Update local state
                if (state.selectedProject && state.selectedProject.id === projectId) {
                    delete state.selectedProject.estimateFile;
                }
                
                if (state.editingProject && state.editingProject.id === projectId) {
                    delete state.editingProject.estimateFile;
                }
                
                // Update projects list
                const projectIndex = state.projects.findIndex(p => p.id === projectId);
                if (projectIndex !== -1) {
                    delete state.projects[projectIndex].estimateFile;
                }
                
                render();
                alert('×§×•×‘×¥ ×”××•××“×Ÿ × ××—×§');
            } catch (error) {
                console.error('Error removing estimate file:', error);
                alert('×©×’×™××” ×‘××—×™×§×ª ×§×•×‘×¥ ×”××•××“×Ÿ: ' + error.message);
            }
        }
        
        function viewEstimateFile() {
            const estimateFile = state.selectedProject?.estimateFile || state.editingProject?.estimateFile;
            if (estimateFile) {
                state.viewingAttachment = estimateFile;
                render();
            }
        }
        
        async function openInvoiceAttachment(invoiceId, attachmentIndex) {
            // Find the invoice in the current project's invoices
            const project = state.selectedProject || state.editingProject;
            if (!project || !project.invoices) return;
            
            const invoice = project.invoices.find(inv => inv.id === invoiceId);
            if (!invoice || !invoice.attachments || !invoice.attachments[attachmentIndex]) return;
            
            const attachment = invoice.attachments[attachmentIndex];
            let fileUrl = attachment.url;
            
            // If it's a Firebase Storage URL, get authenticated download URL
            if (attachment.url && attachment.url.includes('firebasestorage.googleapis.com')) {
                try {
                    const storageRef = storage.refFromURL(attachment.url);
                    fileUrl = await getAuthenticatedDownloadURL(storageRef);
                } catch (error) {
                    console.error('Error getting authenticated URL:', error);
                    // Keep original URL as fallback
                }
            }
            
            // Open file directly in new tab
            window.open(fileUrl, '_blank');
        }
        
        async function viewInvoiceAttachment(invoiceId, attachmentIndex) {
            // Find the invoice in the current project's invoices
            const project = state.selectedProject || state.editingProject;
            if (!project || !project.invoices) return;
            
            const invoice = project.invoices.find(inv => inv.id === invoiceId);
            if (!invoice || !invoice.attachments || !invoice.attachments[attachmentIndex]) return;
            
            const attachment = invoice.attachments[attachmentIndex];
            
            // If it's a Firebase Storage URL, get authenticated download URL
            if (attachment.url && attachment.url.includes('firebasestorage.googleapis.com')) {
                try {
                    const storageRef = storage.refFromURL(attachment.url);
                    const authenticatedUrl = await getAuthenticatedDownloadURL(storageRef);
                    attachment.url = authenticatedUrl;
                } catch (error) {
                    console.error('Error getting authenticated URL:', error);
                    // Keep original URL as fallback
                }
            }
            
            state.viewingAttachment = attachment;
            render();
        }

        // UI Functions
        function backToClients() {
            state.view = 'clients';
            state.selectedClient = null;
            state.selectedProject = null;
            state.projects = [];
            updateHistory();
            render();
        }

        function backToProjects() {
            state.selectedProject = null;
            updateHistory();
            render();
        }
        
        function showProjectsView() {
            state.view = 'projects';
            state.selectedClient = null;
            state.selectedProject = null;
            updateHistory();
            render();
        }
        
        function showSuppliersView() {
            state.view = 'suppliers';
            state.selectedClient = null;
            state.selectedProject = null;
            updateHistory();
            loadSuppliers();
        }
        
        function showOrdersView() {
            state.view = 'orders';
            state.selectedClient = null;
            state.selectedProject = null;
            updateHistory();
            loadOrders();
        }
        
        function showWorkScheduleView() {
            state.view = 'workSchedule';
            state.selectedClient = null;
            state.selectedProject = null;
            updateHistory();
            loadWorkAssignments();
        }

        // ===== RENDER =====

        // Global Navigation Tabs Manager
        function renderNavigationTabs(activeTab) {
            const tabs = [
                { id: 'clients', label: '×œ×§×•×—×•×ª', onclick: "state.view = 'clients'; updateHistory(); render()" },
                { id: 'all-projects', label: '×›×œ ×”×¤×¨×•×™×§×˜×™×', onclick: "state.view = 'all-projects'; updateHistory(); render()" },
                { id: 'suppliers', label: '×¡×¤×§×™×', onclick: "showSuppliersView()" },
                { id: 'orders', label: '×”×–×× ×•×ª', onclick: "showOrdersView()" },
                { id: 'work-schedule', label: '×¡×™×“×•×¨ ×¢×‘×•×“×”', onclick: "showWorkScheduleView()" }
            ];

            return `
                <div class="mb-6">
                    <div class="flex border-b border-gray-200">
                        ${tabs.map(tab => `
                            <button onclick="${tab.onclick}"
                                class="px-6 py-3 text-sm font-medium border-b-2 ${
                                    activeTab === tab.id
                                        ? 'border-blue-500 text-blue-600 bg-blue-50'
                                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                                }">
                                ${tab.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            
            // Show loading state
            if (state.loading) {
                app.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="text-center">
                            <div class="text-2xl mb-4">â³ ×˜×•×¢×Ÿ...</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Show login screen if not authenticated
            if (!state.user) {
                app.innerHTML = renderLoginView();
                return;
            }
            
            // Show main app if authenticated
            if (state.view === 'clients') {
                // Ensure clients are loaded
                if (state.user && state.clients.length === 0 && !state.loading) {
                    loadClients();
                }
                app.innerHTML = renderClientsView();
            } else if (state.view === 'suppliers') {
                // Ensure suppliers are loaded
                if (state.user && !state.suppliersLoaded && !state.loadingSuppliers) {
                    loadSuppliers();
                }
                app.innerHTML = renderSuppliersView();
            } else if (state.view === 'orders') {
                // Ensure orders and suppliers are loaded
                if (state.user && !state.ordersLoaded && !state.loadingOrders) {
                    loadOrders();
                }
                if (state.user && !state.suppliersLoaded && !state.loadingSuppliers) {
                    loadSuppliers();
                }
                // Ensure clients are loaded for project selection
                if (state.user && state.clients.length === 0 && !state.loading) {
                    loadClients();
                }
                // Load all projects (minimal data) for orders dropdown
                if (state.user && state.ordersLoaded && (!state.allProjects || state.allProjects.length === 0)) {
                    loadAllProjects();
                }
                app.innerHTML = renderOrdersView();
            } else if (state.view === 'workSchedule') {
                // Ensure work assignments are loaded
                if (state.user && !state.assignmentsLoaded && !state.loadingAssignments) {
                    loadWorkAssignments();
                }
                // Ensure clients and projects are loaded
                if (state.user && state.clients.length === 0 && !state.loading) {
                    loadClients();
                }
                if (state.user && (!state.allProjects || state.allProjects.length === 0)) {
                    loadAllProjects();
                }
                app.innerHTML = renderWorkScheduleView();
            } else if (state.view === 'all-projects') {
                // Ensure all projects are loaded
                if (state.user && (!state.allProjects || state.allProjects.length === 0)) {
                    loadAllProjects();
                }
                app.innerHTML = renderAllProjectsView();
            } else if (state.selectedProject) {
                app.innerHTML = renderInvoiceView();
            } else {
                app.innerHTML = renderProjectsView();
            }
            
            if (state.viewingAttachment) {
                app.innerHTML += renderAttachmentModal();
            }
            
            if (state.showCropModal) {
                app.innerHTML += renderCropModal();
            }
            
            if (state.ocrResults) {
                app.innerHTML += renderOCRApprovalModal();
            }
        }

        function renderLoginView() {
            return `
                <div class="flex items-center justify-center min-h-screen">
                    <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4">
                        <div class="text-center">
                            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                                ××¢×¨×›×ª × ×™×”×•×œ ×¤×¨×•×™×§×˜×™×
                            </h1>
                            <p class="text-gray-600 mb-8">
                                ${isDevelopment ? '××¦×‘ ×¤×™×ª×•×— - ×”×ª×—×‘×¨×•×ª ××•×˜×•××˜×™×ª' : '×”×ª×—×‘×¨ ×›×“×™ ×œ×’×©×ª ×œ××¢×¨×›×ª'}
                            </p>
                            ${!isDevelopment ? `
                                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="h-5 w-5 text-blue-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="text-sm font-medium text-blue-800">×”×’×‘×œ×ª ×’×™×©×”</span>
                                    </div>
                                    <p class="mt-1 text-sm text-blue-700">
                                        ×¨×§ ××©×ª××©×™× ×-${ALLOWED_DOMAIN} ××• ×¨×©×™××ª ××©×ª××©×™× ××•×¨×©×™×ª ×™×›×•×œ×™× ×œ×’×©×ª ×œ××¢×¨×›×ª.
                                    </p>
                                </div>
                            ` : ''}
                            ${isDevelopment ? `
                                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <div class="flex items-center">
                                        <svg class="h-5 w-5 text-yellow-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                        <span class="text-sm font-medium text-yellow-800">××¦×‘ ×¤×™×ª×•×—</span>
                                    </div>
                                    <p class="mt-1 text-sm text-yellow-700">×”××¢×¨×›×ª ×¤×•×¢×œ×ª ×‘××¦×‘ ×¤×™×ª×•×—. ×œ×—×¥ ×¢×œ "×”×ª×—×‘×¨" ×›×“×™ ×œ×”××©×™×š.</p>
                                </div>
                            ` : ''}
                            <button onclick="signInWithGoogle()" 
                                class="w-full bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-3">
                                <svg class="w-5 h-5" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                ${isDevelopment ? '×”×ª×—×‘×¨ (××¦×‘ ×¤×™×ª×•×—)' : '×”×ª×—×‘×¨ ×¢× Google'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderClientsView() {
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-800">
                            ××¢×¨×›×ª × ×™×”×•×œ ×¤×¨×•×™×§×˜×™×
                        </h1>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600">×©×œ×•×, ${state.user.displayName || state.user.email}</span>
                            <button onclick="signOut()" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                ×”×ª× ×ª×§
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Tabs -->
                    ${renderNavigationTabs('clients')}

                    <div class="bg-white rounded-lg shadow-lg p-6 max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">×œ×§×•×—×•×ª</h2>
                            <button onclick="state.showNewClient = !state.showNewClient; render()" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2">
                                <span class="text-xl">+</span>
                                ×œ×§×•×— ×—×“×©
                            </button>
                        </div>

                        ${state.showNewClient ? `
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h3 class="font-bold mb-3">×œ×§×•×— ×—×“×©</h3>
                                <input type="text" placeholder="×©× ×”×œ×§×•×— *" value="${state.newClient.name}" 
                                    onchange="state.newClient.name = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="email" placeholder="××™××™×™×œ" value="${state.newClient.email}" 
                                    onchange="state.newClient.email = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="tel" placeholder="×˜×œ×¤×•×Ÿ" value="${state.newClient.phone}" 
                                    onchange="state.newClient.phone = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <textarea placeholder="×”×¢×¨×•×ª" value="${state.newClient.notes}" 
                                    onchange="state.newClient.notes = this.value" class="w-full p-2 mb-2 border rounded" rows="2"></textarea>
                                <div class="flex gap-2">
                                    <button onclick="addClient()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                                        ×”×•×¡×£
                                    </button>
                                    <button onclick="state.showNewClient = false; render()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">
                                        ×‘×™×˜×•×œ
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="space-y-3">
                            ${state.clients.length === 0 ? `
                                <div class="text-center py-12 text-gray-400">
                                    <p class="text-xl">×¢×“×™×™×Ÿ ×œ× ×”×•×¡×¤×ª ×œ×§×•×—×•×ª</p>
                                    <p class="text-sm mt-2">×œ×—×¥ ×¢×œ "×œ×§×•×— ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                                </div>
                            ` : state.clients.map(client => {
                                const isEditing = state.editingClient?.id === client.id;
                                
                                if (isEditing) {
                                    return `
                                        <div class="p-4 rounded-lg bg-blue-100 border-2 border-blue-500">
                                            <input type="text" value="${state.editingClient.name}" 
                                                onchange="state.editingClient.name = this.value" class="w-full p-2 mb-2 border rounded"/>
                                            <input type="email" value="${state.editingClient.email}" 
                                                onchange="state.editingClient.email = this.value" class="w-full p-2 mb-2 border rounded"/>
                                            <input type="tel" value="${state.editingClient.phone}" 
                                                onchange="state.editingClient.phone = this.value" class="w-full p-2 mb-2 border rounded"/>
                                            <textarea value="${state.editingClient.notes}" 
                                                onchange="state.editingClient.notes = this.value" class="w-full p-2 mb-2 border rounded" rows="2"></textarea>
                                            <div class="flex gap-2">
                                                <button onclick="saveEditClient()" class="flex-1 bg-green-500 text-white p-2 rounded">×©××•×¨</button>
                                                <button onclick="state.editingClient = null; render()" class="flex-1 bg-gray-400 text-white p-2 rounded">×‘×™×˜×•×œ</button>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                return `
                                    <div class="p-4 rounded-lg bg-gray-50 hover:bg-gray-100 transition cursor-pointer"
                                        onclick="selectClient('${client.id}')">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-lg text-gray-800">${client.name}</h3>
                                                ${client.email ? `<p class="text-sm text-gray-600">ğŸ“§ ${client.email}</p>` : ''}
                                                ${client.phone ? `<p class="text-sm text-gray-600">ğŸ“ ${client.phone}</p>` : ''}
                                                ${client.notes ? `<p class="text-sm text-gray-500 mt-1">${client.notes}</p>` : ''}
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="event.stopPropagation(); state.editingClient = ${JSON.stringify(client).replace(/"/g, '&quot;')}; render()" 
                                                    class="text-blue-500 hover:text-blue-700 p-2">âœï¸</button>
                                                <button onclick="event.stopPropagation(); deleteClient('${client.id}')" 
                                                    class="text-red-500 hover:text-red-700 p-2">ğŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProjectsView() {
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="mb-6 flex items-center gap-4">
                        <button onclick="backToClients()" class="text-blue-600 hover:text-blue-700 flex items-center gap-2">
                            <span class="text-2xl">â†</span>
                            <span>×—×–×¨×” ×œ×œ×§×•×—×•×ª</span>
                        </button>
                        <h1 class="text-3xl font-bold text-gray-800">
                            ${state.selectedClient.name}
                        </h1>
                    </div>

                    <!-- Navigation Tabs -->
                    ${renderNavigationTabs(null)}

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">×¤×¨×•×™×§×˜×™×</h2>
                            <div class="flex items-center gap-4">
                                <select onchange="state.projectStatusFilter = this.value; render()" 
                                    class="px-3 py-2 border rounded-lg bg-white">
                                    <option value="all" ${state.projectStatusFilter === 'all' ? 'selected' : ''}>×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                    ${projectStatuses.map(status => 
                                        `<option value="${status}" ${state.projectStatusFilter === status ? 'selected' : ''}>${status}</option>`
                                    ).join('')}
                                </select>
                                <button onclick="state.showNewProject = !state.showNewProject; render()" 
                                    class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center gap-2">
                                    <span class="text-xl">+</span>
                                    ×¤×¨×•×™×§×˜ ×—×“×©
                                </button>
                            </div>
                        </div>

                        ${state.showNewProject ? `
                            <div class="mb-6 p-4 bg-green-50 rounded-lg">
                                <h3 class="font-bold mb-3">×¤×¨×•×™×§×˜ ×—×“×©</h3>
                                <input type="text" placeholder="×©× ×”×¤×¨×•×™×§×˜" value="${state.newProject.name}" 
                                    onchange="state.newProject.name = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="number" placeholder="×”×›× ×¡×” ××”×œ×§×•×— (â‚ª)" value="${state.newProject.revenue}" 
                                    onchange="state.newProject.revenue = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="date" value="${state.newProject.creationDate}" 
                                    onchange="state.newProject.creationDate = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <textarea placeholder="×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”×¤×¨×•×™×§×˜" value="${state.newProject.description}" 
                                    onchange="state.newProject.description = this.value" class="w-full p-2 mb-2 border rounded" rows="2"></textarea>
                                <select onchange="state.newProject.status = this.value" class="w-full p-2 mb-2 border rounded">
                                    ${projectStatuses.map(status => `<option value="${status}" ${state.newProject.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                                </select>
                                <label class="flex items-center gap-2 mb-2 p-2 border rounded bg-gray-50">
                                    <input type="checkbox" ${state.newProject.activeInSchedule ? 'checked' : ''} 
                                        onchange="state.newProject.activeInSchedule = this.checked; render()" 
                                        class="w-4 h-4"/>
                                    <span>×¤×¢×™×œ ×‘×¡×™×“×•×¨ ×¢×‘×•×“×”</span>
                                </label>
                                <div class="flex gap-2">
                                    <button onclick="addProject()" class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600">
                                        ×”×•×¡×£
                                    </button>
                                    <button onclick="state.showNewProject = false; render()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">
                                        ×‘×™×˜×•×œ
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${state.projects.length === 0 ? `
                                <div class="col-span-full text-center py-12 text-gray-400">
                                    <p class="text-xl">×¢×“×™×™×Ÿ ×œ× ×”×•×¡×¤×ª ×¤×¨×•×™×§×˜×™× ×œ×œ×§×•×— ×–×”</p>
                                </div>
                            ` : state.projects.filter(project => 
                                state.projectStatusFilter === 'all' || project.status === state.projectStatusFilter
                            ).map(project => {
                                const { totalExpenses, profit, profitMargin } = calculateTotals(project);
                                const isEditing = state.editingProject?.id === project.id;
                                
                                if (isEditing) {
                                    return `
                                        <div class="p-4 rounded-lg bg-blue-100 border-2 border-blue-500">
                                            <input type="text" value="${state.editingProject.name}" 
                                                onchange="state.editingProject.name = this.value" class="w-full p-2 mb-2 border rounded"/>
                                            <input type="number" value="${state.editingProject.revenue}" 
                                                onchange="state.editingProject.revenue = this.value" class="w-full p-2 mb-2 border rounded"/>
                                            <input type="date" value="${state.editingProject.creationDate || new Date().toISOString().split('T')[0]}" 
                                                onchange="state.editingProject.creationDate = this.value" class="w-full p-2 mb-2 border rounded"/>
                                            <textarea placeholder="×ª×™××•×¨ ×§×¦×¨ ×©×œ ×”×¤×¨×•×™×§×˜" value="${state.editingProject.description || ''}" 
                                                onchange="state.editingProject.description = this.value" class="w-full p-2 mb-2 border rounded" rows="2"></textarea>
                                            <select onchange="state.editingProject.status = this.value; render()" class="w-full p-2 mb-2 border rounded">
                                                ${projectStatuses.map(status => `<option value="${status}" ${state.editingProject.status === status ? 'selected' : ''}>${status}</option>`).join('')}
                                            </select>
                                            <label class="flex items-center gap-2 mb-2 p-2 border rounded bg-gray-50">
                                                <input type="checkbox" ${state.editingProject.activeInSchedule !== false ? 'checked' : ''} 
                                                    onchange="state.editingProject.activeInSchedule = this.checked; render()" 
                                                    class="w-4 h-4"/>
                                                <span>×¤×¢×™×œ ×‘×¡×™×“×•×¨ ×¢×‘×•×“×”</span>
                                            </label>
                                            ${state.editingProject.status === '××•××“×Ÿ' ? `
                                                <div class="mt-3 p-3 bg-purple-50 rounded border">
                                                    <label class="block text-sm font-semibold text-purple-800 mb-2">×§×•×‘×¥ ××•××“×Ÿ (PDF)</label>
                                                    <input type="file" accept=".pdf" onchange="handleEstimateFileUpload(event)" 
                                                        class="w-full p-2 border rounded text-sm"/>
                                                    ${state.editingProject.estimateFile ? `
                                                        <div class="mt-2 flex items-center justify-between bg-white p-2 rounded border">
                                                            <span class="text-sm">ğŸ“„ ${state.editingProject.estimateFile.name}</span>
                                                            <button onclick="removeEstimateFile()" class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}
                                            <div class="flex gap-2">
                                                <button onclick="saveEditProject()" class="flex-1 bg-green-500 text-white p-2 rounded text-sm">×©××•×¨</button>
                                                <button onclick="state.editingProject = null; render()" class="flex-1 bg-gray-400 text-white p-2 rounded text-sm">×‘×™×˜×•×œ</button>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                return `
                                    <div class="p-4 rounded-lg bg-gradient-to-br from-white to-gray-50 border-2 border-gray-200 hover:border-blue-400 transition cursor-pointer"
                                        onclick="selectProject('${project.id}')">
                                        <div class="flex justify-between items-start mb-2">
                                        <div class="flex-1">
                                            <h3 class="font-bold text-lg">${project.name}</h3>
                                            ${project.description ? `<p class="text-sm text-gray-600 mt-1 line-clamp-2">${project.description}</p>` : ''}
                                            <div class="flex items-center gap-2 mt-1">
                                                <span class="text-xs px-2 py-1 rounded ${
                                                    project.status === '×©×•×œ×' ? 'bg-green-100 text-green-800' :
                                                    project.status === '×œ×ª×©×œ×•×' ? 'bg-yellow-100 text-yellow-800' :
                                                    project.status === '×‘×‘×™×¦×•×¢' ? 'bg-blue-100 text-blue-800' :
                                                    project.status === '××•××“×Ÿ' ? 'bg-purple-100 text-purple-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }">${project.status || '×¤×ª×•×—'}</span>
                                                ${project.createdAt ? `<span class="text-xs text-gray-500">ğŸ“… ${new Date(project.createdAt.toDate ? project.createdAt.toDate() : project.createdAt).toLocaleDateString('he-IL')}</span>` : ''}
                                                ${project.estimateFile ? `<span class="text-xs text-blue-600">ğŸ“„ ××•××“×Ÿ</span>` : ''}
                                            </div>
                                        </div>
                                            <div class="flex gap-1">
                                                <button onclick="event.stopPropagation(); state.editingProject = ${JSON.stringify(project).replace(/"/g, '&quot;')}; render()" 
                                                    class="text-blue-500 hover:text-blue-700 text-sm">âœï¸</button>
                                                <button onclick="event.stopPropagation(); deleteProject('${project.id}')" 
                                                    class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                        <div class="text-sm space-y-2 mt-3">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">×”×•×¦××•×ª:</span>
                                                <span class="font-semibold text-red-600">â‚ª${totalExpenses.toLocaleString()}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">×”×›× ×¡×•×ª:</span>
                                                <span class="font-semibold text-blue-600">â‚ª${project.revenue.toLocaleString()}</span>
                                            </div>
                                            <div class="flex justify-between pt-2 border-t ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                <span class="font-bold">×¨×•×•×—:</span>
                                                <span class="font-bold">â‚ª${profit.toLocaleString()}</span>
                                            </div>
                                            <div class="text-xs text-center ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                ${profitMargin.toFixed(1)}% ×¨×•×•×—×™×•×ª
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAllProjectsView() {
            // Filter projects by status
            const filteredProjects = state.allProjects.filter(project =>
                state.allProjectsStatusFilter === 'all' || project.status === state.allProjectsStatusFilter
            );

            // Group projects by client
            const projectsByClient = {};
            filteredProjects.forEach(project => {
                const clientId = project.clientId;
                if (!projectsByClient[clientId]) {
                    projectsByClient[clientId] = {
                        clientName: project.clientName,
                        projects: []
                    };
                }
                projectsByClient[clientId].projects.push(project);
            });

            // Calculate total stats
            const totalProjects = filteredProjects.length;
            const totalRevenue = filteredProjects.reduce((sum, p) => sum + (p.revenue || 0), 0);
            const totalExpenses = filteredProjects.reduce((sum, p) => {
                const projectExpenses = (p.invoices || []).reduce((s, inv) => s + inv.amount, 0);
                return sum + projectExpenses;
            }, 0);
            const totalProfit = totalRevenue - totalExpenses;

            return `
                <div class="max-w-7xl mx-auto p-6">
                    <!-- Header -->
                    <div class="mb-6 flex items-center justify-between">
                        <h1 class="text-3xl font-bold text-gray-800">×›×œ ×”×¤×¨×•×™×§×˜×™×</h1>
                        <button onclick="state.view = 'clients'; updateHistory(); render()"
                            class="text-blue-600 hover:text-blue-700 flex items-center gap-2">
                            <span class="text-2xl">â†</span>
                            <span>×—×–×¨×” ×œ×œ×§×•×—×•×ª</span>
                        </button>
                    </div>

                    <!-- Navigation Tabs -->
                    ${renderNavigationTabs('all-projects')}

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-600 mb-1">×¡×”"×› ×¤×¨×•×™×§×˜×™×</div>
                            <div class="text-2xl font-bold text-gray-800">${totalProjects}</div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-600 mb-1">×¡×”"×› ×”×›× ×¡×•×ª</div>
                            <div class="text-2xl font-bold text-blue-600">â‚ª${totalRevenue.toLocaleString()}</div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-600 mb-1">×¡×”"×› ×”×•×¦××•×ª</div>
                            <div class="text-2xl font-bold text-red-600">â‚ª${totalExpenses.toLocaleString()}</div>
                        </div>
                        <div class="${totalProfit >= 0 ? 'bg-green-50' : 'bg-red-50'} p-4 rounded-lg shadow">
                            <div class="text-sm text-gray-600 mb-1">×¨×•×•×— ×›×•×œ×œ</div>
                            <div class="text-2xl font-bold ${totalProfit >= 0 ? 'text-green-600' : 'text-red-600'}">â‚ª${totalProfit.toLocaleString()}</div>
                        </div>
                    </div>

                    <!-- Status Filter -->
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">×¤×¨×•×™×§×˜×™× ×œ×¤×™ ×œ×§×•×—</h2>
                            <select onchange="state.allProjectsStatusFilter = this.value; render()"
                                class="px-3 py-2 border rounded-lg bg-white">
                                <option value="all" ${state.allProjectsStatusFilter === 'all' ? 'selected' : ''}>×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                                ${projectStatuses.map(status =>
                                    `<option value="${status}" ${state.allProjectsStatusFilter === status ? 'selected' : ''}>${status}</option>`
                                ).join('')}
                            </select>
                        </div>

                        ${filteredProjects.length === 0 ? `
                            <div class="text-center py-12 text-gray-400">
                                <p class="text-xl">××™×Ÿ ×¤×¨×•×™×§×˜×™× ×œ×”×¦×’×”</p>
                            </div>
                        ` : `
                            <div class="space-y-6">
                                ${Object.keys(projectsByClient).map(clientId => {
                                    const group = projectsByClient[clientId];
                                    return `
                                        <div class="border-2 border-gray-200 rounded-lg p-4 bg-gradient-to-r from-gray-50 to-white">
                                            <h3 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b-2 border-blue-500">
                                                ${group.clientName}
                                                <span class="text-sm font-normal text-gray-600">(${group.projects.length} ×¤×¨×•×™×§×˜×™×)</span>
                                            </h3>
                                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                ${group.projects.map(project => {
                                                    const { totalExpenses, profit, profitMargin } = calculateTotals(project);
                                                    return `
                                                        <div class="p-4 rounded-lg bg-white border-2 border-gray-200 hover:border-blue-400 transition cursor-pointer"
                                                            onclick="selectClient('${project.clientId}'); selectProject('${project.id}')">
                                                            <div class="flex justify-between items-start mb-2">
                                                                <div class="flex-1">
                                                                    <h4 class="font-bold text-lg">${project.name}</h4>
                                                                    ${project.description ? `<p class="text-sm text-gray-600 mt-1 line-clamp-2">${project.description}</p>` : ''}
                                                                    <div class="flex items-center gap-2 mt-1">
                                                                        <span class="text-xs px-2 py-1 rounded ${
                                                                            project.status === '×¤×ª×•×—' ? 'bg-blue-100 text-blue-800' :
                                                                            project.status === '××•××“×Ÿ' ? 'bg-purple-100 text-purple-800' :
                                                                            project.status === '×”×–×× ×”' ? 'bg-yellow-100 text-yellow-800' :
                                                                            project.status === '×‘×‘×™×¦×•×¢' ? 'bg-orange-100 text-orange-800' :
                                                                            project.status === '×—×©×‘×•×Ÿ' ? 'bg-pink-100 text-pink-800' :
                                                                            project.status === '×œ×ª×©×œ×•×' ? 'bg-indigo-100 text-indigo-800' :
                                                                            project.status === '×©×•×œ×' ? 'bg-green-100 text-green-800' :
                                                                            'bg-gray-100 text-gray-800'
                                                                        }">${project.status}</span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="text-sm space-y-2 mt-3">
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">×”×•×¦××•×ª:</span>
                                                                    <span class="font-semibold text-red-600">â‚ª${totalExpenses.toLocaleString()}</span>
                                                                </div>
                                                                <div class="flex justify-between">
                                                                    <span class="text-gray-600">×”×›× ×¡×•×ª:</span>
                                                                    <span class="font-semibold text-blue-600">â‚ª${project.revenue.toLocaleString()}</span>
                                                                </div>
                                                                <div class="flex justify-between pt-2 border-t ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                                    <span class="font-bold">×¨×•×•×—:</span>
                                                                    <span class="font-bold">â‚ª${profit.toLocaleString()}</span>
                                                                </div>
                                                                <div class="text-xs text-center ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                                                                    ${profitMargin.toFixed(1)}% ×¨×•×•×—×™×•×ª
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderWorkScheduleView() {
            // Helper functions for calendar
            const getWeekDates = (date) => {
                const curr = new Date(date);
                const week = [];
                curr.setDate(curr.getDate() - curr.getDay()); // Sunday
                for (let i = 0; i < 7; i++) {
                    week.push(new Date(curr));
                    curr.setDate(curr.getDate() + 1);
                }
                return week;
            };
            
            const getMonthDates = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const dates = [];
                
                // Start from Sunday before or on first day
                const start = new Date(firstDay);
                start.setDate(start.getDate() - start.getDay());
                
                // End on Saturday after last day
                const end = new Date(lastDay);
                end.setDate(end.getDate() + (6 - end.getDay()));
                
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    dates.push(new Date(d));
                }
                
                return dates;
            };
            
            const formatDate = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            const formatDisplayDate = (date) => {
                return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit' });
            };
            
            const getDayName = (date) => {
                const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
                return days[date.getDay()];
            };
            
            const dates = state.calendarViewMode === 'week' ? getWeekDates(state.calendarDate) : getMonthDates(state.calendarDate);
            const isWeekView = state.calendarViewMode === 'week';
            
            // Filter only projects with status "×‘×‘×™×¦×•×¢"
            const activeProjects = (state.allProjects || []).filter(p => p.status === '×‘×‘×™×¦×•×¢');
            
            // Group projects by client
            const projectsByClient = {};
            activeProjects.forEach(project => {
                const clientName = project.clientName || '×œ×œ× ×œ×§×•×—';
                if (!projectsByClient[clientName]) {
                    projectsByClient[clientName] = [];
                }
                projectsByClient[clientName].push(project);
            });
            
            // Get assignments for current view
            const getAssignmentsForDateAndProject = (date, projectId) => {
                const dateStr = formatDate(date);
                return state.workAssignments.filter(a => a.date === dateStr && a.projectId === projectId);
            };
            
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-800">
                            ×¡×™×“×•×¨ ×¢×‘×•×“×”
                        </h1>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600">×©×œ×•×, ${state.user.displayName || state.user.email}</span>
                            <button onclick="signOut()" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                ×”×ª× ×ª×§
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Tabs -->
                    ${renderNavigationTabs('work-schedule')}

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <!-- Calendar Controls -->
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center gap-4">
                                <button onclick="state.calendarDate.setDate(state.calendarDate.getDate() - ${isWeekView ? 7 : 30}); render()" 
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">
                                    â†
                                </button>
                                <h2 class="text-xl font-bold">
                                    ${state.calendarDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' })}
                                </h2>
                                <button onclick="state.calendarDate.setDate(state.calendarDate.getDate() + ${isWeekView ? 7 : 30}); render()" 
                                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">
                                    â†’
                                </button>
                                <button onclick="state.calendarDate = new Date(); render()" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                    ×”×™×•×
                                </button>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="state.calendarViewMode = 'week'; render()" 
                                    class="px-4 py-2 rounded ${isWeekView ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    ×©×‘×•×¢
                                </button>
                                <button onclick="state.calendarViewMode = 'month'; render()" 
                                    class="px-4 py-2 rounded ${!isWeekView ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                    ×—×•×“×©
                                </button>
                            </div>
                        </div>

                        <!-- Workers List (Draggable) -->
                        <div class="mb-6">
                            <h3 class="font-bold mb-3">×¢×•×‘×“×™×:</h3>
                            <div class="flex gap-2 flex-wrap">
                                ${workers.map(worker => `
                                    <div draggable="true" 
                                        ondragstart="state.draggedWorker = '${worker.id}'; event.dataTransfer.effectAllowed = 'copy';"
                                        ondragend="state.draggedWorker = null;"
                                        class="bg-blue-100 border-2 border-blue-300 px-4 py-2 rounded cursor-move hover:bg-blue-200 hover:shadow-lg transition-all">
                                        ${worker.name}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Calendar Grid -->
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse text-sm">
                                <thead>
                                    <tr>
                                        <th class="border p-2 bg-gray-100 text-sm sticky right-0 z-10" style="min-width: 200px;">×œ×§×•×— / ×¤×¨×•×™×§×˜</th>
                                        ${dates.slice(0, isWeekView ? 7 : dates.length).map(date => `
                                            <th class="border p-2 bg-gray-100 text-xs ${date.getDay() === 6 ? 'bg-purple-50' : date.getDay() === 0 ? 'bg-blue-50' : ''}">
                                                <div>${getDayName(date)}</div>
                                                <div class="text-xs text-gray-600">${formatDisplayDate(date)}</div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.keys(projectsByClient).length === 0 ? `
                                        <tr>
                                            <td colspan="${dates.slice(0, isWeekView ? 7 : dates.length).length + 1}" class="border p-8 text-center text-gray-400">
                                                <p class="text-lg">××™×Ÿ ×¤×¨×•×™×§×˜×™× ×¤×¢×™×œ×™× ×‘×¡×™×“×•×¨ ×¢×‘×•×“×”</p>
                                                <p class="text-sm mt-2">×¡××Ÿ ×¤×¨×•×™×§×˜×™× ×›"×¤×¢×™×œ ×‘×¡×™×“×•×¨ ×¢×‘×•×“×”" ×›×“×™ ×©×™×•×¤×™×¢×• ×›××Ÿ</p>
                                            </td>
                                        </tr>
                                    ` : Object.entries(projectsByClient).map(([clientName, projects]) => `
                                        <!-- Client Header Row -->
                                        <tr class="bg-gray-200">
                                            <td colspan="${dates.slice(0, isWeekView ? 7 : dates.length).length + 1}" class="border p-2 font-bold text-right">
                                                ${clientName}
                                            </td>
                                        </tr>
                                        <!-- Project Rows -->
                                        ${projects.map(project => `
                                            <tr class="hover:bg-gray-50">
                                                <td class="border p-2 bg-gray-50 font-semibold text-sm sticky right-0 z-10" title="${project.name}">
                                                    <div class="truncate">${project.name}</div>
                                                </td>
                                                ${dates.slice(0, isWeekView ? 7 : dates.length).map(date => {
                                                    const assignments = getAssignmentsForDateAndProject(date, project.id);
                                                    const dateStr = formatDate(date);
                                                    const isWeekend = date.getDay() === 6 || date.getDay() === 0;
                                                    return `
                                                        <td class="border p-1 align-top ${date.getDay() === 6 ? 'bg-purple-50' : date.getDay() === 0 ? 'bg-blue-50' : ''}"
                                                            ondragover="event.preventDefault(); event.dataTransfer.dropEffect = 'copy'; this.style.backgroundColor = '#d1fae5';"
                                                            ondragleave="this.style.backgroundColor = '${date.getDay() === 6 ? '#faf5ff' : date.getDay() === 0 ? '#eff6ff' : ''}';"
                                                            ondrop="event.preventDefault(); this.style.backgroundColor = '${date.getDay() === 6 ? '#faf5ff' : date.getDay() === 0 ? '#eff6ff' : ''}'; if (state.draggedWorker) { addWorkAssignment(state.draggedWorker, '${project.id}', '${dateStr}'); }"
                                                            style="min-height: 50px; min-width: 80px;">
                                                            ${assignments.map(assignment => {
                                                                const worker = workers.find(w => w.id === assignment.workerId);
                                                                return `
                                                                    <div class="bg-green-100 border border-green-400 rounded px-2 py-1 mb-1 text-xs relative group inline-block mr-1">
                                                                        <span class="font-semibold">${worker ? worker.name : assignment.workerId}</span>
                                                                        <button onclick="deleteWorkAssignment('${assignment.id}')" 
                                                                            class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                                                                            Ã—
                                                                        </button>
                                                                    </div>
                                                                `;
                                                            }).join('')}
                                                        </td>
                                                    `;
                                                }).join('')}
                                            </tr>
                                        `).join('')}
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <!-- Legend -->
                        <div class="mt-4 flex gap-4 text-sm text-gray-600 flex-wrap">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-100 border border-green-400"></div>
                                <span>×¢×•×‘×“ ××©×•×‘×¥</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-50 border"></div>
                                <span>×™×•× ×¨××©×•×Ÿ</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-purple-50 border"></div>
                                <span>×©×‘×ª</span>
                            </div>
                        </div>

                        <!-- Instructions -->
                        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                            <h4 class="font-bold mb-2">×”×•×¨××•×ª ×©×™××•×©:</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                                <li>×’×¨×•×¨ ×¢×•×‘×“ ××”×¨×©×™××” ×œ××¢×œ×” ×œ×ª× ×‘×œ×•×— ×”×©× ×” (×‘×©×•×¨×ª ×”×¤×¨×•×™×§×˜ ×”×¨×¦×•×™)</li>
                                <li>×”×¢×•×‘×“ ×™×ª×•×•×¡×£ ×œ×¤×¨×•×™×§×˜ ×‘××•×ª×• ×ª××¨×™×š</li>
                                <li>×œ×—×¥ ×¢×œ ×”-X ×›×“×™ ×œ××—×•×§ ×©×™×‘×•×¥</li>
                                <li>×”×—×œ×£ ×‘×™×Ÿ ×ª×¦×•×’×ª ×©×‘×•×¢ ×œ×—×•×“×©</li>
                                <li>×¨×§ ×¤×¨×•×™×§×˜×™× ×¢× ×¡×˜×˜×•×¡ "×‘×‘×™×¦×•×¢" ××•×¤×™×¢×™× ×‘×¡×™×“×•×¨</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInvoiceView() {
            const { totalExpenses, ordersExpenses, workerExpensesTotal, profit, profitMargin } = calculateTotals(state.selectedProject);
            
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="mb-6 flex items-center gap-4">
                        <button onclick="backToProjects()" class="text-blue-600 hover:text-blue-700 flex items-center gap-2">
                            <span class="text-2xl">â†</span>
                            <span>×—×–×¨×” ×œ×¤×¨×•×™×§×˜×™×</span>
                        </button>
                        <div>
                            <div class="text-sm text-gray-600">${state.selectedClient.name}</div>
                            <h1 class="text-3xl font-bold text-gray-800">${state.selectedProject.name}</h1>
                            ${state.selectedProject.description ? `<p class="text-sm text-gray-600 mt-1">${state.selectedProject.description}</p>` : ''}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">×”×•×¦××•×ª ×¤×¨×•×™×§×˜</h2>
                        </div>

                        ${state.selectedProject.status === '××•××“×Ÿ' ? `
                            <div class="mb-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
                                <h3 class="font-bold text-purple-800 mb-3">ğŸ“„ ×§×•×‘×¥ ××•××“×Ÿ</h3>
                                ${state.selectedProject.estimateFile ? `
                                    <div class="flex items-center justify-between bg-white p-3 rounded border">
                                        <div class="flex items-center gap-2">
                                            <span class="text-blue-600">ğŸ“„</span>
                                            <a href="${state.selectedProject.estimateFile.url}" target="_blank" class="font-medium text-blue-600 hover:text-blue-800 cursor-pointer">${state.selectedProject.estimateFile.name}</a>
                                            <span class="text-xs text-gray-500">
                                                ${new Date(state.selectedProject.estimateFile.uploadedAt?.toDate ? state.selectedProject.estimateFile.uploadedAt.toDate() : state.selectedProject.estimateFile.uploadedAt).toLocaleDateString('he-IL')}
                                            </span>
                                        </div>
                                        <div class="flex gap-2">
                                            <a href="${state.selectedProject.estimateFile.url}" target="_blank" class="text-blue-600 hover:text-blue-700 text-sm px-2 py-1 border border-blue-600 rounded">×¦×¤×”</a>
                                            <button onclick="removeEstimateFile()" class="text-red-600 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="text-center py-4">
                                        <p class="text-gray-600 mb-3">×œ× ×”×•×¢×œ×” ×§×•×‘×¥ ××•××“×Ÿ ×¢×“×™×™×Ÿ</p>
                                        <input type="file" accept=".pdf" onchange="handleEstimateFileUpload(event)" 
                                            class="block mx-auto text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                                    </div>
                                `}
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-200">
                                <div class="text-sm text-gray-600 mb-1">×”×–×× ×•×ª</div>
                                <div class="text-2xl font-bold text-orange-600">â‚ª${ordersExpenses.toLocaleString()}</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                                <div class="text-sm text-gray-600 mb-1">×¢×•×‘×“×™×</div>
                                <div class="text-2xl font-bold text-purple-600">â‚ª${workerExpensesTotal.toLocaleString()}</div>
                            </div>
                            <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
                                <div class="text-sm text-gray-600 mb-1">×¡×š ×”×•×¦××•×ª</div>
                                <div class="text-2xl font-bold text-red-600">â‚ª${totalExpenses.toLocaleString()}</div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">×”×›× ×¡×•×ª</div>
                                <div class="text-2xl font-bold text-blue-600">â‚ª${(state.selectedProject.revenue || 0).toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 mb-6">
                            <div class="${profit >= 0 ? 'bg-green-50' : 'bg-red-50'} p-4 rounded-lg border-2 ${profit >= 0 ? 'border-green-200' : 'border-red-200'}">
                                <div class="text-sm text-gray-600 mb-1">×¨×•×•×— × ×§×™</div>
                                <div class="text-2xl font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    â‚ª${profit.toLocaleString()}
                                </div>
                                <div class="text-sm mt-1">${profitMargin.toFixed(1)}% ××”×›× ×¡×•×ª</div>
                            </div>
                        </div>

                        <!-- Worker Expenses Section -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">×”×•×¦××•×ª ×¢×•×‘×“×™× (××¡×™×“×•×¨ ×”×¢×‘×•×“×”)</h3>
                                <a href="#" onclick="showWorkScheduleView(); return false;" 
                                    class="text-blue-600 hover:text-blue-700 text-sm">
                                    ×¢×‘×•×¨ ×œ×¡×™×“×•×¨ ×¢×‘×•×“×” â†
                                </a>
                            </div>
                            ${renderWorkerExpensesList()}
                        </div>

                        <!-- Orders Section -->
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">×”×–×× ×•×ª</h3>
                                <a href="#" onclick="showOrdersView(); return false;" 
                                    class="text-blue-600 hover:text-blue-700 text-sm">
                                    ×¢×‘×•×¨ ×œ× ×™×”×•×œ ×”×–×× ×•×ª â†
                                </a>
                            </div>
                            ${renderProjectOrdersList()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNewInvoiceForm() {
            const total = state.newInvoice.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            
            return `
                <div class="mb-6 p-4 bg-green-50 rounded-lg">
                    <h3 class="font-bold mb-3">×—×©×‘×•× ×™×ª ×—×“×©×”</h3>
                    
                    <!-- OCR Upload Section -->
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-bold text-blue-800">ğŸ¤– ×¡×¨×™×§×ª ×—×©×‘×•× ×™×ª ×¢× AI</h4>
                            <select onchange="state.ocrMethod = this.value" 
                                class="px-3 py-1 border rounded text-sm">
                                <option value="tesseract" ${state.ocrMethod === 'tesseract' ? 'selected' : ''}>×—×™× × (Tesseract)</option>
                                <option value="google" ${state.ocrMethod === 'google' ? 'selected' : ''}>××ª×§×“× (Google Vision)</option>
                            </select>
                        </div>
                        
                        ${state.ocrProcessing ? `
                            <div class="text-center py-4">
                                <div class="mb-2 text-sm">××¢×‘×“ ×ª××•× ×”...</div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all" 
                                        style="width: ${state.ocrProgress}%"></div>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">${state.ocrProgress}%</div>
                            </div>
                        ` : `
                            <!-- Drag and Drop Zone -->
                            <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center transition-colors"
                                ondragover="handleDragOver(event)"
                                ondragleave="handleDragLeave(event)"
                                ondrop="handleDrop(event)">
                                <div class="text-4xl mb-2">ğŸ“„</div>
                                <p class="text-sm font-medium text-gray-700 mb-1">×’×¨×•×¨ ×•×©×—×¨×¨ ×§×•×‘×¥ ×›××Ÿ</p>
                                <p class="text-xs text-gray-500 mb-3">××•</p>
                                <label class="inline-block cursor-pointer">
                                    <span class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 inline-block">
                                        ×‘×—×¨ ×§×•×‘×¥
                                    </span>
                                    <input type="file" accept="image/*,application/pdf" onchange="handleOCRUpload(event)" 
                                        class="hidden"/>
                                </label>
                                <p class="text-xs text-gray-600 mt-3">
                                    ×ª××™×›×” ×‘: ×ª××•× ×•×ª (JPG, PNG) ×•-PDF â€¢ ×¢×“ 10MB
                                </p>
                            </div>
                        `}
                    </div>
                    
                    <input type="text" placeholder="×©× ×”×¡×¤×§" value="${state.newInvoice.supplier}" 
                        onchange="state.newInvoice.supplier = this.value" class="w-full p-2 mb-2 border rounded"/>
                    
                    <input type="text" placeholder="××¡×¤×¨ ×—×©×‘×•× ×™×ª" value="${state.newInvoice.invoiceNumber}" 
                        onchange="state.newInvoice.invoiceNumber = this.value" class="w-full p-2 mb-2 border rounded"/>
                    
                    <input type="date" value="${state.newInvoice.date}" 
                        onchange="state.newInvoice.date = this.value" class="w-full p-2 mb-3 border rounded"/>

                    <div class="mb-3 p-3 bg-white rounded border">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-semibold">×¤×¨×™×˜×™× ×‘×—×©×‘×•× ×™×ª</span>
                            <button onclick="addInvoiceItem()" class="text-green-600 text-sm hover:text-green-700">
                                â• ×”×•×¡×£ ×¤×¨×™×˜
                            </button>
                        </div>
                        
                        ${state.newInvoice.items.map((item, index) => `
                            <div class="mb-3 p-2 bg-gray-50 rounded">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-sm font-semibold">×¤×¨×™×˜ ${index + 1}</span>
                                    ${state.newInvoice.items.length > 1 ? 
                                        `<button onclick="removeInvoiceItem(${index})" class="text-red-500 text-sm hover:text-red-700">ğŸ—‘ï¸</button>` : 
                                        ''}
                                </div>
                                
                                <select onchange="updateInvoiceItem(${index}, 'category', this.value); render()" 
                                    class="w-full p-2 mb-2 border rounded text-sm">
                                    ${categories.map(cat => `<option value="${cat}" ${item.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                </select>
                                
                                <input type="text" placeholder="×ª×™××•×¨" value="${item.description}" 
                                    onchange="updateInvoiceItem(${index}, 'description', this.value)" 
                                    class="w-full p-2 mb-2 border rounded text-sm"/>
                                
                                <input type="number" placeholder="×¡×›×•× (â‚ª)" value="${item.amount}" 
                                    onchange="updateInvoiceItem(${index}, 'amount', this.value)" 
                                    class="w-full p-2 border rounded text-sm"/>
                            </div>
                        `).join('')}
                        
                        <div class="pt-2 border-t mt-2 flex justify-between items-center font-bold">
                            <span>×¡×”"×›:</span>
                            <span>â‚ª${total.toLocaleString()}</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-2">×§×‘×¦×™× ××¦×•×¨×¤×™×</label>
                        <input type="file" multiple accept="image/*,.pdf" onchange="handleFileUpload(event)" 
                            class="w-full p-2 border rounded text-sm"/>
                        ${state.newInvoice.attachments.length > 0 ? `
                            <div class="mt-2 space-y-1">
                                ${state.newInvoice.attachments.map((file, index) => `
                                    <div class="flex items-center justify-between bg-white p-2 rounded border text-sm">
                                        <span>ğŸ“ ${file.name}${file.size ? ` (${(file.size / 1024).toFixed(0)}KB)` : ''}</span>
                                        <button onclick="removeAttachment(${index})" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <button onclick="addInvoice()" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">
                        ×”×•×¡×£ ×—×©×‘×•× ×™×ª
                    </button>
                </div>
            `;
        }

        function renderEditInvoiceForm() {
            return `
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-bold mb-3">×¢×¨×™×›×ª ×—×©×‘×•× ×™×ª</h3>
                    
                    <input type="text" placeholder="×©× ×”×¡×¤×§" value="${state.editingInvoice.supplier}" 
                        onchange="state.editingInvoice.supplier = this.value" class="w-full p-2 mb-2 border rounded"/>
                    
                    <select onchange="state.editingInvoice.category = this.value" class="w-full p-2 mb-2 border rounded">
                        ${categories.map(cat => `<option value="${cat}" ${state.editingInvoice.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                    </select>
                    
                    <input type="number" placeholder="×¡×›×•× (â‚ª)" value="${state.editingInvoice.amount}" 
                        onchange="state.editingInvoice.amount = this.value" class="w-full p-2 mb-2 border rounded"/>
                    
                    <input type="date" value="${state.editingInvoice.date}" 
                        onchange="state.editingInvoice.date = this.value" class="w-full p-2 mb-2 border rounded"/>
                    
                    <input type="text" placeholder="×ª×™××•×¨" value="${state.editingInvoice.description}" 
                        onchange="state.editingInvoice.description = this.value" class="w-full p-2 mb-3 border rounded"/>

                    <div class="mb-3">
                        <label class="block text-sm font-semibold mb-2">×§×‘×¦×™× ××¦×•×¨×¤×™×</label>
                        <input type="file" multiple accept="image/*,.pdf" onchange="handleEditFileUpload(event)" 
                            class="w-full p-2 border rounded text-sm"/>
                        ${state.editingInvoice.attachments && state.editingInvoice.attachments.length > 0 ? `
                            <div class="mt-2 space-y-1">
                                ${state.editingInvoice.attachments.map((file, index) => `
                                    <div class="flex items-center justify-between bg-white p-2 rounded border text-sm">
                                        <span>ğŸ“ ${file.name}</span>
                                        <button onclick="removeEditAttachment(${index}); render()" class="text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="saveEditInvoice()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                            ×©××•×¨ ×©×™× ×•×™×™×
                        </button>
                        <button onclick="state.editingInvoice = null; render()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">
                            ×‘×™×˜×•×œ
                        </button>
                    </div>
                </div>
            `;
        }

        function renderInvoicesTable() {
            const invoices = state.selectedProject.invoices || [];
            
            if (invoices.length === 0) {
                return `
                    <div class="p-8 text-center text-gray-400 border border-gray-200 rounded-lg">
                        ×¢×“×™×™×Ÿ ×œ× ×”×•×¡×¤×ª ×—×©×‘×•× ×™×•×ª ×œ×¤×¨×•×™×§×˜ ×–×”
                    </div>
                `;
            }
            
            // Group invoices by supplier and invoice number
            const grouped = {};
            invoices.forEach(invoice => {
                const key = `${invoice.supplier}_${invoice.invoiceNumber || 'no-num'}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        supplier: invoice.supplier,
                        invoiceNumber: invoice.invoiceNumber,
                        items: [],
                        totalAmount: 0,
                        date: invoice.date,
                        attachments: invoice.attachments || []
                    };
                }
                grouped[key].items.push(invoice);
                grouped[key].totalAmount += invoice.amount;
            });
            
            const groupedArray = Object.values(grouped);
            
            return `
                <div class="space-y-2">
                    ${groupedArray.map((group, index) => `
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <!-- Group Header (Collapsible) -->
                            <div class="bg-gray-50 p-4 flex items-center justify-between cursor-pointer hover:bg-gray-100"
                                onclick="toggleInvoiceGroup(${index})">
                                <div class="flex items-center gap-4 flex-1">
                                    <span class="text-lg" id="arrow-${index}">â–¼</span>
                                    <div class="flex-1">
                                        <div class="font-bold text-lg">${group.supplier}</div>
                                        ${group.invoiceNumber ? `<div class="text-sm text-gray-600">×—×©×‘×•× ×™×ª ××¡' ${group.invoiceNumber}</div>` : ''}
                                        <div class="text-sm text-gray-500">${new Date(group.date).toLocaleDateString('he-IL')}</div>
                                    </div>
                                    <div class="text-xl font-bold text-blue-600">â‚ª${group.totalAmount.toLocaleString()}</div>
                                    <div class="flex gap-2">
                                        ${group.attachments.length > 0 ? 
                                            `<button onclick="event.stopPropagation(); openInvoiceAttachment('${group.items[0].id}', 0)" class="text-blue-600 hover:text-blue-700 px-3 py-1 border border-blue-600 rounded">ğŸ“„ ×¦×¤×”</button>` : 
                                            ''
                                        }
                                        <button onclick="event.stopPropagation(); deleteWholeInvoice(\`${group.supplier}\`, \`${group.invoiceNumber || ''}\`)" 
                                            class="text-red-600 hover:text-red-700 px-3 py-1 border border-red-600 rounded">ğŸ—‘ï¸ ××—×§ ×—×©×‘×•× ×™×ª</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Group Items (Expandable) -->
                            <div id="group-${index}" class="hidden bg-white">
                                <table class="w-full">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="p-2 text-right text-sm">×§×˜×’×•×¨×™×”</th>
                                            <th class="p-2 text-right text-sm">×ª×™××•×¨</th>
                                            <th class="p-2 text-right text-sm">×¡×›×•×</th>
                                            <th class="p-2 text-right text-sm">×¤×¢×•×œ×•×ª</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${group.items.map(invoice => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="p-2">
                                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${invoice.category || '×©×•× ×•×ª'}</span>
                                                </td>
                                                <td class="p-2 text-sm text-gray-600">${invoice.description || '-'}</td>
                                                <td class="p-2 text-sm font-semibold">â‚ª${invoice.amount.toLocaleString()}</td>
                                                <td class="p-2">
                                                    <button onclick="deleteInvoice('${invoice.id}')" class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function toggleInvoiceGroup(index) {
            const group = document.getElementById(`group-${index}`);
            const arrow = document.getElementById(`arrow-${index}`);
            
            if (group.classList.contains('hidden')) {
                group.classList.remove('hidden');
                arrow.textContent = 'â–²';
            } else {
                group.classList.add('hidden');
                arrow.textContent = 'â–¼';
            }
        }

        function renderWorkerExpensesList() {
            // Get work assignments for this project from ×¡×™×“×•×¨ ×¢×‘×•×“×”
            const projectWorkAssignments = (state.workAssignments || []).filter(a => a.projectId === state.selectedProject.id);
            
            // Group by worker
            const workerDays = {};
            projectWorkAssignments.forEach(assignment => {
                if (!workerDays[assignment.workerId]) {
                    const worker = workers.find(w => w.id === assignment.workerId);
                    workerDays[assignment.workerId] = {
                        workerName: worker ? worker.name : assignment.workerId,
                        days: []
                    };
                }
                workerDays[assignment.workerId].days.push(assignment.date);
            });
            
            // Daily rates editing section
            if (state.editingWorkerRates) {
                return `
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-300">
                        <h4 class="font-bold mb-3">×¢×¨×•×š ×ª×¢×¨×™×¤×™× ×™×•××™×™×</h4>
                        ${workers.map(w => `
                            <div class="flex items-center justify-between p-2 mb-2 bg-white rounded border">
                                <span class="font-medium">${w.name}</span>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-600">â‚ª</span>
                                    <input type="number" value="${state.workerDailyRates[w.id]}" 
                                        onchange="state.workerDailyRates['${w.id}'] = parseInt(this.value) || 0; render()"
                                        class="w-24 p-1 border rounded text-center" step="10"/>
                                    <span class="text-sm text-gray-600">×œ×™×•×</span>
                                </div>
                            </div>
                        `).join('')}
                        <div class="flex gap-2 mt-3">
                            <button onclick="state.editingWorkerRates = false; render()" 
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                ×©××•×¨
                            </button>
                            <button onclick="state.editingWorkerRates = false; render()" 
                                class="flex-1 bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">
                                ×‘×™×˜×•×œ
                            </button>
                        </div>
                    </div>
                `;
            }
            
            if (Object.keys(workerDays).length === 0) {
                return `
                    <div class="p-4 text-center text-gray-400 border border-gray-200 rounded-lg">
                        <p class="mb-2">××™×Ÿ ×¢×•×‘×“×™× ××©×•×‘×¦×™× ×œ×¤×¨×•×™×§×˜ ×–×” ×‘×¡×™×“×•×¨ ×”×¢×‘×•×“×”</p>
                        <p class="text-xs">×©×‘×¥ ×¢×•×‘×“×™× ×‘×¡×™×“×•×¨ ×”×¢×‘×•×“×” ×›×“×™ ×œ×¨××•×ª ××ª ×”×”×•×¦××•×ª ×›××Ÿ</p>
                    </div>
                `;
            }
            
            const totalDays = Object.values(workerDays).reduce((sum, w) => sum + w.days.length, 0);
            const totalCost = projectWorkAssignments.reduce((sum, a) => sum + (state.workerDailyRates[a.workerId] || 0), 0);
            
            return `
                <div class="space-y-3">
                    <!-- Summary Card -->
                    <div class="p-3 bg-purple-100 rounded-lg border-2 border-purple-300">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-sm text-gray-600">×¡×”"×› ×™××™ ×¢×‘×•×“×”</div>
                                <div class="text-2xl font-bold text-purple-700">${totalDays}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">×¡×”"×› ×”×•×¦××•×ª</div>
                                <div class="text-2xl font-bold text-purple-700">â‚ª${totalCost.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Worker Details -->
                    <div class="space-y-2">
                        ${Object.entries(workerDays).map(([workerId, data]) => {
                            const dailyRate = state.workerDailyRates[workerId] || 0;
                            const workerTotal = data.days.length * dailyRate;
                            return `
                                <div class="p-3 bg-purple-50 rounded border hover:border-purple-300">
                                    <div class="flex justify-between items-center">
                                        <div class="flex-1">
                                            <div class="font-bold">${data.workerName}</div>
                                            <div class="text-sm text-gray-600">
                                                ${data.days.length} ×™××™× Ã— â‚ª${dailyRate.toLocaleString()} = 
                                                <span class="font-semibold text-purple-700">â‚ª${workerTotal.toLocaleString()}</span>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-1">
                                                ${data.days.sort().map(d => new Date(d).toLocaleDateString('he-IL', { day: 'numeric', month: 'numeric' })).join(', ')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Edit Rates Button -->
                    <button onclick="state.editingWorkerRates = true; render()" 
                        class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center gap-2">
                        <span>âš™ï¸</span>
                        <span>×¢×¨×•×š ×ª×¢×¨×™×¤×™× ×™×•××™×™×</span>
                    </button>
                </div>
            `;
        }

        function renderProjectOrdersList() {
            const projectOrders = (state.orders || []).filter(o => o.projectId === state.selectedProject.id);
            
            if (projectOrders.length === 0) {
                return `
                    <div class="p-4 text-center text-gray-400 border border-gray-200 rounded-lg">
                        ××™×Ÿ ×”×–×× ×•×ª ×œ×¤×¨×•×™×§×˜ ×–×”
                    </div>
                `;
            }
            
            return `
                <div class="space-y-2">
                    ${projectOrders.map(order => `
                        <div class="flex items-center justify-between p-3 bg-orange-50 rounded border hover:border-orange-300">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold">×”×–×× ×” ${order.orderNumber}</span>
                                    <span class="text-xs text-gray-500">${new Date(order.orderDate).toLocaleDateString('he-IL')}</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    ×¡×¤×§: ${order.supplierName}
                                </div>
                                <div class="text-sm font-semibold text-orange-700">
                                    ×¡×”"×›: â‚ª${order.totalSum.toLocaleString()}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generateOrderPDF('${order.id}')" 
                                    class="text-blue-600 hover:text-blue-700 text-sm px-2 py-1 border border-blue-600 rounded">
                                    ğŸ“„ ×”×•×¨×“ PDF
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderSuppliersView() {
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-800">
                            ××¢×¨×›×ª × ×™×”×•×œ ×”×–×× ×•×ª
                        </h1>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600">×©×œ×•×, ${state.user.displayName || state.user.email}</span>
                            <button onclick="signOut()" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                ×”×ª× ×ª×§
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Tabs -->
                    ${renderNavigationTabs('suppliers')}

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">×¡×¤×§×™×</h2>
                            <button onclick="state.showNewSupplier = !state.showNewSupplier; render()" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2">
                                <span class="text-xl">+</span>
                                ×¡×¤×§ ×—×“×©
                            </button>
                        </div>

                        ${state.showNewSupplier ? `
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h3 class="font-bold mb-3">×¡×¤×§ ×—×“×©</h3>
                                <input type="text" placeholder="×©× ×”×¡×¤×§ *" value="${state.newSupplier.name}" 
                                    onchange="state.newSupplier.name = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="text" placeholder="×©× ××™×© ×§×©×¨" value="${state.newSupplier.contactName}" 
                                    onchange="state.newSupplier.contactName = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="tel" placeholder="×˜×œ×¤×•×Ÿ ××™×© ×§×©×¨" value="${state.newSupplier.contactPhone}" 
                                    onchange="state.newSupplier.contactPhone = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="email" placeholder="××™××™×™×œ ××™×© ×§×©×¨" value="${state.newSupplier.contactEmail}" 
                                    onchange="state.newSupplier.contactEmail = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <textarea placeholder="×ª× ××™ ×ª×©×œ×•×" value="${state.newSupplier.paymentConditions}" 
                                    onchange="state.newSupplier.paymentConditions = this.value" class="w-full p-2 mb-2 border rounded" rows="2"></textarea>
                                <div class="flex gap-2">
                                    <button onclick="addSupplier()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                                        ×”×•×¡×£
                                    </button>
                                    <button onclick="state.showNewSupplier = false; render()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">
                                        ×‘×™×˜×•×œ
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${(!state.suppliers || state.suppliers.length === 0) ? `
                                <div class="col-span-full text-center py-12 text-gray-400">
                                    <p class="text-xl">×¢×“×™×™×Ÿ ×œ× ×”×•×¡×¤×ª ×¡×¤×§×™×</p>
                                    <p class="text-sm mt-2">×œ×—×¥ ×¢×œ "×¡×¤×§ ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                                </div>
                            ` : (state.suppliers || []).map(supplier => {
                                const isEditing = state.editingSupplier?.id === supplier.id;
                                
                                if (isEditing) {
                                    return `
                                        <div class="p-4 rounded-lg bg-blue-100 border-2 border-blue-500">
                                            <input type="text" value="${state.editingSupplier.name}" 
                                                onchange="state.editingSupplier.name = this.value" class="w-full p-2 mb-2 border rounded"/>
                                            <input type="text" value="${state.editingSupplier.contactName}" 
                                                onchange="state.editingSupplier.contactName = this.value" class="w-full p-2 mb-2 border rounded" placeholder="××™×© ×§×©×¨"/>
                                            <input type="tel" value="${state.editingSupplier.contactPhone}" 
                                                onchange="state.editingSupplier.contactPhone = this.value" class="w-full p-2 mb-2 border rounded" placeholder="×˜×œ×¤×•×Ÿ"/>
                                            <input type="email" value="${state.editingSupplier.contactEmail}" 
                                                onchange="state.editingSupplier.contactEmail = this.value" class="w-full p-2 mb-2 border rounded" placeholder="××™××™×™×œ"/>
                                            <textarea value="${state.editingSupplier.paymentConditions}" 
                                                onchange="state.editingSupplier.paymentConditions = this.value" class="w-full p-2 mb-2 border rounded" rows="2" placeholder="×ª× ××™ ×ª×©×œ×•×"></textarea>
                                            <div class="flex gap-2">
                                                <button onclick="updateSupplier('${supplier.id}')" class="flex-1 bg-green-500 text-white p-2 rounded hover:bg-green-600 text-sm">
                                                    ×©××•×¨
                                                </button>
                                                <button onclick="state.editingSupplier = null; render()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500 text-sm">
                                                    ×‘×™×˜×•×œ
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                return `
                                    <div class="p-4 bg-gray-50 rounded-lg hover:shadow-md transition-shadow border border-gray-200">
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="font-bold text-lg text-gray-800">${supplier.name}</h3>
                                            <div class="flex gap-1">
                                                <button onclick="state.editingSupplier = {...${JSON.stringify(supplier)}}; render()" 
                                                    class="text-blue-500 hover:text-blue-700 px-2 py-1 rounded">
                                                    âœï¸
                                                </button>
                                                <button onclick="deleteSupplier('${supplier.id}')" 
                                                    class="text-red-500 hover:text-red-700 px-2 py-1 rounded">
                                                    ğŸ—‘ï¸
                                                </button>
                                            </div>
                                        </div>
                                        ${supplier.contactName ? `<p class="text-sm text-gray-600">ğŸ‘¤ ${supplier.contactName}</p>` : ''}
                                        ${supplier.contactPhone ? `<p class="text-sm text-gray-600">ğŸ“ ${supplier.contactPhone}</p>` : ''}
                                        ${supplier.contactEmail ? `<p class="text-sm text-gray-600">ğŸ“§ ${supplier.contactEmail}</p>` : ''}
                                        ${supplier.paymentConditions ? `<p class="text-sm text-gray-600 mt-2"><strong>×ª× ××™ ×ª×©×œ×•×:</strong> ${supplier.paymentConditions}</p>` : ''}
                                        ${(supplier.documents && supplier.documents.length > 0) ? `
                                            <div class="mt-2">
                                                <p class="text-xs font-semibold text-gray-700 mb-1">××¡××›×™×:</p>
                                                ${supplier.documents.map((doc, index) => `
                                                    <div class="flex justify-between items-center text-xs bg-white p-1 rounded mb-1">
                                                        <a href="${doc.url}" target="_blank" class="text-blue-600 hover:underline truncate">${doc.name}</a>
                                                        <button onclick="removeSupplierDocument('${supplier.id}', ${index})" class="text-red-500 hover:text-red-700 ml-1">âœ•</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        <div class="mt-3">
                                            <label class="cursor-pointer bg-green-500 text-white text-xs px-3 py-1 rounded hover:bg-green-600 inline-block">
                                                + ××¡××š
                                                <input type="file" class="hidden" onchange="uploadSupplierDocument('${supplier.id}', this.files[0])"/>
                                            </label>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOrdersView() {
            // Get all projects for order creation
            // Build from state.allProjects if available, otherwise use state.projects
            const allProjects = state.allProjects || [];
            
            // Group orders by project for "by-project" tab
            const ordersByProject = {};
            (state.orders || []).forEach(order => {
                if (!ordersByProject[order.projectName]) {
                    ordersByProject[order.projectName] = [];
                }
                ordersByProject[order.projectName].push(order);
            });
            
            return `
                <div class="max-w-7xl mx-auto p-6">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-4xl font-bold text-gray-800">
                            ××¢×¨×›×ª ×”×–×× ×•×ª
                        </h1>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-gray-600">×©×œ×•×, ${state.user.displayName || state.user.email}</span>
                            <button onclick="signOut()" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                                ×”×ª× ×ª×§
                            </button>
                        </div>
                    </div>

                    <!-- Navigation Tabs -->
                    ${renderNavigationTabs('orders')}

                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">×”×–×× ×•×ª</h2>
                            <div class="flex gap-2">
                                ${!state.pdfTemplate ? `
                                    <label class="cursor-pointer bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex items-center gap-2">
                                        ğŸ“„ ×”×¢×œ×” ×ª×‘× ×™×ª PDF
                                        <input type="file" accept="application/pdf" class="hidden" onchange="uploadPDFTemplate(this.files[0])"/>
                                    </label>
                                ` : '<span class="text-sm text-green-600">âœ“ ×ª×‘× ×™×ª PDF ×”×•×¢×œ×ª×”</span>'}
                                <button onclick="state.showNewOrder = !state.showNewOrder; render()" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-2">
                                    <span class="text-xl">+</span>
                                    ×”×–×× ×” ×—×“×©×”
                                </button>
                            </div>
                        </div>

                        <!-- Orders View Tabs -->
                        <div class="mb-4">
                            <div class="flex border-b border-gray-200">
                                <button onclick="state.ordersViewTab = 'all'; render()" 
                                    class="px-4 py-2 text-sm font-medium ${state.ordersViewTab === 'all' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}">
                                    ×›×œ ×”×”×–×× ×•×ª
                                </button>
                                <button onclick="state.ordersViewTab = 'by-project'; render()" 
                                    class="px-4 py-2 text-sm font-medium ${state.ordersViewTab === 'by-project' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-500 hover:text-gray-700'}">
                                    ×œ×¤×™ ×¤×¨×•×™×§×˜
                                </button>
                            </div>
                        </div>

                        ${state.showNewOrder ? `
                            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                                <h3 class="font-bold mb-3">×”×–×× ×” ×—×“×©×”</h3>
                                
                                <select onchange="state.newOrder.selectedClientId = this.value; state.newOrder.projectId = ''; render()" class="w-full p-2 mb-2 border rounded">
                                    <option value="">×‘×—×¨ ×œ×§×•×— *</option>
                                    ${state.clients.map(c => `
                                        <option value="${c.id}" ${state.newOrder.selectedClientId === c.id ? 'selected' : ''}>
                                            ${c.name}
                                        </option>
                                    `).join('')}
                                </select>
                                
                                ${state.newOrder.selectedClientId ? `
                                    <select onchange="state.newOrder.projectId = this.value" class="w-full p-2 mb-2 border rounded">
                                        <option value="">×‘×—×¨ ×¤×¨×•×™×§×˜ *</option>
                                        ${allProjects.filter(p => p.clientId === state.newOrder.selectedClientId).map(p => `
                                            <option value="${p.id}" ${state.newOrder.projectId === p.id ? 'selected' : ''}>
                                                ${p.name}
                                            </option>
                                        `).join('')}
                                    </select>
                                ` : ''}
                                
                                <select onchange="state.newOrder.supplierId = this.value" class="w-full p-2 mb-2 border rounded">
                                    <option value="">×‘×—×¨ ×¡×¤×§ *</option>
                                    ${(state.suppliers || []).map(s => `
                                        <option value="${s.id}" ${state.newOrder.supplierId === s.id ? 'selected' : ''}>
                                            ${s.name}
                                        </option>
                                    `).join('')}
                                </select>
                                
                                <input type="date" value="${state.newOrder.orderDate}" 
                                    onchange="state.newOrder.orderDate = this.value" class="w-full p-2 mb-2 border rounded" placeholder="×ª××¨×™×š ×”×–×× ×”"/>
                                
                                <div class="mb-3">
                                    <h4 class="font-semibold mb-2">×¤×¨×™×˜×™×:</h4>
                                    ${state.newOrder.items.map((item, index) => `
                                        <div class="flex gap-2 mb-2">
                                            <input type="text" placeholder="×ª×™××•×¨" value="${item.description}" 
                                                onchange="state.newOrder.items[${index}].description = this.value; render()" 
                                                class="flex-1 p-2 border rounded"/>
                                            <input type="number" placeholder="×›××•×ª" value="${item.quantity}" 
                                                onchange="state.newOrder.items[${index}].quantity = this.value; calculateOrderTotals()" 
                                                class="w-20 p-2 border rounded"/>
                                            <select onchange="state.newOrder.items[${index}].unit = this.value" 
                                                class="p-2 border rounded">
                                                <option value="×™×—'" ${item.unit === '×™×—\'' ? 'selected' : ''}>×™×—'</option>
                                                <option value="××´×" ${item.unit === '××´×' ? 'selected' : ''}>××´×</option>
                                                <option value="×—×‘'" ${item.unit === '×—×‘\'' ? 'selected' : ''}>×—×‘'</option>
                                            </select>
                                            <input type="number" placeholder="××—×™×¨" value="${item.price}" 
                                                onchange="state.newOrder.items[${index}].price = this.value; calculateOrderTotals()" 
                                                class="w-24 p-2 border rounded"/>
                                            <span class="p-2 text-sm text-gray-600">
                                                â‚ª${((parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0)).toFixed(2)}
                                            </span>
                                            <button onclick="removeOrderItem(${index})" 
                                                class="bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600">
                                                âœ•
                                            </button>
                                        </div>
                                    `).join('')}
                                    <button onclick="addOrderItem()" 
                                        class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                                        + ×¤×¨×™×˜
                                    </button>
                                    <div class="mt-2 text-right font-bold">
                                        ×¡×”"×›: â‚ª${state.newOrder.items.reduce((sum, item) => sum + ((parseFloat(item.quantity) || 0) * (parseFloat(item.price) || 0)), 0).toFixed(2)}
                                    </div>
                                </div>
                                
                                <textarea placeholder="×”×¢×¨×•×ª" value="${state.newOrder.comments}" 
                                    onchange="state.newOrder.comments = this.value" class="w-full p-2 mb-2 border rounded" rows="2"></textarea>
                                <input type="text" placeholder="×›×ª×•×‘×ª ××©×œ×•×—" value="${state.newOrder.deliveryAddress}" 
                                    onchange="state.newOrder.deliveryAddress = this.value" class="w-full p-2 mb-2 border rounded"/>
                                <input type="text" placeholder="×”×–××™×Ÿ" value="${state.newOrder.orderedBy}" 
                                    onchange="state.newOrder.orderedBy = this.value" class="w-full p-2 mb-2 border rounded"/>
                                
                                <div class="flex gap-2">
                                    <button onclick="addOrder()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                                        ×¦×•×¨ ×”×–×× ×”
                                    </button>
                                    <button onclick="state.showNewOrder = false; render()" class="flex-1 bg-gray-400 text-white p-2 rounded hover:bg-gray-500">
                                        ×‘×™×˜×•×œ
                                    </button>
                                </div>
                            </div>
                        ` : ''}

                        ${state.ordersViewTab === 'all' ? `
                            <div class="overflow-x-auto">
                                ${(!state.orders || state.orders.length === 0) ? `
                                    <div class="text-center py-12 text-gray-400">
                                        <p class="text-xl">×¢×“×™×™×Ÿ ×œ× × ×•×¦×¨×• ×”×–×× ×•×ª</p>
                                        <p class="text-sm mt-2">×œ×—×¥ ×¢×œ "×”×–×× ×” ×—×“×©×”" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                                    </div>
                                ` : `
                                    <table class="w-full">
                                        <thead class="bg-gray-100">
                                            <tr>
                                                <th class="p-3 text-right">××¡×¤×¨ ×”×–×× ×”</th>
                                                <th class="p-3 text-right">×¤×¨×•×™×§×˜</th>
                                                <th class="p-3 text-right">×¡×¤×§</th>
                                                <th class="p-3 text-right">×¤×¨×™×˜×™×</th>
                                                <th class="p-3 text-right">×¡×”"×›</th>
                                                <th class="p-3 text-right">×ª××¨×™×š</th>
                                                <th class="p-3 text-right">×¤×¢×•×œ×•×ª</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${(state.orders || []).map(order => `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="p-3 font-bold">${order.orderNumber}</td>
                                                    <td class="p-3">${order.projectName}</td>
                                                    <td class="p-3">${order.supplierName}</td>
                                                    <td class="p-3 text-sm text-gray-600">
                                                        ${order.items.map(item => `${item.quantity || 1}x ${item.description.substring(0, 20)}${item.description.length > 20 ? '...' : ''}`).join('<br>')}
                                                    </td>
                                                    <td class="p-3">â‚ª${order.totalSum.toFixed(2)}</td>
                                                    <td class="p-3">${order.createdAt?.toDate ? new Date(order.createdAt.toDate()).toLocaleDateString('he-IL') : 'N/A'}</td>
                                                    <td class="p-3">
                                                        <button onclick="generateOrderPDF('${order.id}')" 
                                                            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm mr-2">
                                                            ğŸ“„ PDF
                                                        </button>
                                                        <button onclick="deleteOrder('${order.id}')" 
                                                            class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
                                                            ğŸ—‘ï¸
                                                        </button>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                `}
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${Object.keys(ordersByProject).length === 0 ? `
                                    <div class="text-center py-12 text-gray-400">
                                        <p class="text-xl">×¢×“×™×™×Ÿ ×œ× × ×•×¦×¨×• ×”×–×× ×•×ª</p>
                                    </div>
                                ` : Object.entries(ordersByProject).map(([projectName, orders]) => `
                                    <div class="border rounded-lg p-4">
                                        <h3 class="font-bold text-lg mb-3">${projectName}</h3>
                                        <table class="w-full">
                                            <thead class="bg-gray-100">
                                                <tr>
                                                    <th class="p-2 text-right text-sm">××¡×¤×¨ ×”×–×× ×”</th>
                                                    <th class="p-2 text-right text-sm">×¡×¤×§</th>
                                                    <th class="p-2 text-right text-sm">×¤×¨×™×˜×™×</th>
                                                    <th class="p-2 text-right text-sm">×¡×”"×›</th>
                                                    <th class="p-2 text-right text-sm">×ª××¨×™×š</th>
                                                    <th class="p-2 text-right text-sm">×¤×¢×•×œ×•×ª</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${orders.map(order => `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="p-2 font-bold text-sm">${order.orderNumber}</td>
                                                        <td class="p-2 text-sm">${order.supplierName}</td>
                                                        <td class="p-2 text-xs text-gray-600">
                                                            ${order.items.map(item => `${item.quantity || 1}x ${item.description.substring(0, 15)}${item.description.length > 15 ? '...' : ''}`).join('<br>')}
                                                        </td>
                                                        <td class="p-2 text-sm">â‚ª${order.totalSum.toFixed(2)}</td>
                                                        <td class="p-2 text-sm">${order.createdAt?.toDate ? new Date(order.createdAt.toDate()).toLocaleDateString('he-IL') : 'N/A'}</td>
                                                        <td class="p-2">
                                                            <button onclick="generateOrderPDF('${order.id}')" 
                                                                class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 text-xs mr-1">
                                                                ğŸ“„
                                                            </button>
                                                            <button onclick="deleteOrder('${order.id}')" 
                                                                class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600 text-xs">
                                                                ğŸ—‘ï¸
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderAttachmentModal() {
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="state.viewingAttachment = null; render()">
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-auto p-6" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg">${state.viewingAttachment.name}</h3>
                            <button onclick="state.viewingAttachment = null; render()" class="text-gray-500 hover:text-gray-700 text-2xl">âœ•</button>
                        </div>
                        <div class="mb-4">
                            <a href="${state.viewingAttachment.url}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                ×¤×ª×— ×§×•×‘×¥ ×‘×—×œ×•×Ÿ ×—×“×©
                            </a>
                        </div>
                        ${state.viewingAttachment.type.startsWith('image/') ? 
                            `<img src="${state.viewingAttachment.url}" alt="${state.viewingAttachment.name}" class="max-w-full h-auto"/>` :
                            state.viewingAttachment.type === 'application/pdf' ?
                            `<div class="w-full h-[70vh] border border-gray-300 rounded-lg flex items-center justify-center bg-gray-100">
                                <div class="text-center">
                                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-gray-600 mb-4">×§×•×‘×¥ PDF</p>
                                    <a href="${state.viewingAttachment.url}" target="_blank" class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        ×¤×ª×— PDF
                                    </a>
                                </div>
                            </div>` :
                            `<div class="w-full h-[70vh] border border-gray-300 rounded-lg flex items-center justify-center bg-gray-100">
                                <div class="text-center">
                                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <p class="text-gray-600 mb-4">${state.viewingAttachment.name}</p>
                                    <a href="${state.viewingAttachment.url}" target="_blank" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        ×”×•×¨×“ ×§×•×‘×¥
                                    </a>
                                </div>
                            </div>`
                        }
                    </div>
                </div>
            `;
        }
        
        function renderCropModal() {
            if (!state.showCropModal) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
                    <div class="bg-white rounded-lg max-w-4xl w-full p-6 max-h-[90vh] flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-bold">âœ‚ï¸ ×—×™×ª×•×š ×ª××•× ×”</h3>
                            <button onclick="closeCropModal()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-4">
                            ×—×ª×•×š ××ª ×”×ª××•× ×” ×›×“×™ ×œ×”×ª××§×“ ×‘××–×•×¨ ×”×—×©×‘×•× ×™×ª ×‘×œ×‘×“. ×–×” ×™×©×¤×¨ ××ª ×“×™×•×§ ×”×¡×¨×™×§×”.
                        </p>
                        
                        <!-- Cropper Container -->
                        <div class="flex-1 overflow-hidden mb-4" style="max-height: 60vh;">
                            <img id="crop-image" style="max-width: 100%; display: block;">
                        </div>
                        
                        <!-- Cropper Controls -->
                        <div class="flex gap-2 mb-4 justify-center flex-wrap">
                            <button onclick="state.cropperInstance?.rotate(-90)" 
                                class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                                â†¶ ×¡×™×‘×•×‘ ×©×××œ×”
                            </button>
                            <button onclick="state.cropperInstance?.rotate(90)" 
                                class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                                â†· ×¡×™×‘×•×‘ ×™××™× ×”
                            </button>
                            <button onclick="state.cropperInstance?.zoom(0.1)" 
                                class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                                ğŸ”+ ×–×•× ×¤× ×™××”
                            </button>
                            <button onclick="state.cropperInstance?.zoom(-0.1)" 
                                class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                                ğŸ”- ×–×•× ×”×—×•×¦×”
                            </button>
                            <button onclick="state.cropperInstance?.reset()" 
                                class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
                                ğŸ”„ ××™×¤×•×¡
                            </button>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-3">
                            <button onclick="applyCropAndProcess()" 
                                class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium">
                                âœ“ ×—×ª×•×š ×•×¡×¨×•×§
                            </button>
                            <button onclick="skipCropAndProcess()" 
                                class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">
                                â© ×“×œ×’ ×¢×œ ×—×™×ª×•×š
                            </button>
                            <button onclick="closeCropModal()" 
                                class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200">
                                âœ• ×‘×™×˜×•×œ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderOCRApprovalModal() {
            if (!state.ocrResults) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="event.target === this && cancelOCRResults()">
                    <div class="bg-white rounded-lg max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4">ğŸ” ××™×©×•×¨ × ×ª×•× ×™ ×—×©×‘×•× ×™×ª</h3>
                        <p class="text-sm text-gray-600 mb-4">×‘×“×•×§ ××ª ×”× ×ª×•× ×™× ×©×—×•×œ×¦×• ×•×ª×§×Ÿ ×‘××™×“×ª ×”×¦×•×¨×š</p>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">×¡×¤×§</label>
                                <input type="text" value="${state.ocrResults.supplier || ''}" 
                                    onchange="state.ocrResults.supplier = this.value"
                                    class="w-full p-2 border rounded"/>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">××¡×¤×¨ ×—×©×‘×•× ×™×ª</label>
                                <input type="text" value="${state.ocrResults.invoiceNumber || ''}" 
                                    onchange="state.ocrResults.invoiceNumber = this.value"
                                    class="w-full p-2 border rounded"/>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">×ª××¨×™×š</label>
                                <input type="date" value="${state.ocrResults.date || ''}" 
                                    onchange="state.ocrResults.date = this.value"
                                    class="w-full p-2 border rounded"/>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">×¤×¨×™×˜×™×</label>
                                ${(state.ocrResults.items || []).map((item, index) => `
                                    <div class="flex gap-2 mb-2">
                                        <input type="text" placeholder="×ª×™××•×¨" value="${item.description || ''}"
                                            onchange="state.ocrResults.items[${index}].description = this.value"
                                            class="flex-1 p-2 border rounded text-sm"/>
                                        <input type="number" placeholder="×¡×›×•×" value="${item.amount || ''}"
                                            onchange="state.ocrResults.items[${index}].amount = this.value"
                                            class="w-32 p-2 border rounded text-sm"/>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="approveOCRResults()" 
                                class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                âœ“ ××©×¨ ×•×”×•×¡×£
                            </button>
                            <button onclick="cancelOCRResults()" 
                                class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                                âœ• ×‘×™×˜×•×œ
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== BROWSER HISTORY MANAGEMENT =====
        
        function updateHistory() {
            const historyState = {
                view: state.view,
                selectedClient: state.selectedClient?.id || null,
                selectedProject: state.selectedProject?.id || null,
                showNewClient: state.showNewClient,
                showNewProject: state.showNewProject,
                showNewInvoice: state.showNewInvoice,
                editingClient: state.editingClient?.id || null,
                editingProject: state.editingProject?.id || null,
                editingInvoice: state.editingInvoice?.id || null
            };
            
            const url = getCurrentURL();
            window.history.pushState(historyState, '', url);
        }
        
        function getCurrentURL() {
            let url = '/';
            
            if (state.view === 'clients' && state.selectedClient) {
                url = `/clients/${state.selectedClient.id}`;
                if (state.selectedProject) {
                    url += `/projects/${state.selectedProject.id}`;
                }
            } else if (state.view === 'projects') {
                url = '/projects';
            } else if (state.view === 'suppliers') {
                url = '/suppliers';
            } else if (state.view === 'orders') {
                url = '/orders';
            } else if (state.view === 'workSchedule') {
                url = '/work-schedule';
            }
            
            return url;
        }
        
        function handlePopState(event) {
            if (event.state) {
                // Restore state from history
                const historyState = event.state;
                
                // Restore view
                state.view = historyState.view || 'clients';
                
                // Restore selected client
                if (historyState.selectedClient) {
                    const client = state.clients.find(c => c.id === historyState.selectedClient);
                    state.selectedClient = client || null;
                } else {
                    state.selectedClient = null;
                }
                
                // Restore selected project
                if (historyState.selectedProject && state.selectedClient) {
                    const project = state.selectedClient.projects?.find(p => p.id === historyState.selectedProject);
                    state.selectedProject = project || null;
                } else {
                    state.selectedProject = null;
                }
                
                // Clear editing states
                state.editingClient = null;
                state.editingProject = null;
                state.editingInvoice = null;
                state.showNewClient = false;
                state.showNewProject = false;
                state.showNewInvoice = false;
                
                render();
            } else {
                // No history state, go to default view
                state.view = 'clients';
                state.selectedClient = null;
                state.selectedProject = null;
                render();
            }
        }
        
        // Listen for browser back/forward buttons
        window.addEventListener('popstate', handlePopState);
        
        // Initialize app
        console.log('Initializing app...');
        loadClients();
    </script>
</body>
</html>